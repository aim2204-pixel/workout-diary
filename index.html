<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Мой Дневник Тренировок</title>
    <link rel="manifest" href="/workout-diary/manifest.json" crossorigin="use-credentials">
    <meta name="theme-color" content="#9d4edd">
    <meta name="mobile-web-app-capable" content="yes">    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ==================== CSS СБРОС ==================== */
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        
        /* ==================== CSS ПЕРЕМЕННЫЕ (ТЕМА ПО УМОЛЧАНИЮ - DARK) ==================== */
        :root {
            /* Цветовая палитра */
            --color-primary: #9d4edd;
            --color-secondary: #00b4d8;
            --color-success: #48bb78;
            --color-warning: #ffb347;
            --color-danger: #ff6b6b;
            --color-accent: #ffd166;
            --color-info: #90e0ef;
            
            /* Фоны */
            --bg-body: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --bg-header: rgba(0, 30, 60, 0.95);
            --bg-card: rgba(255, 255, 255, 0.08);
            --bg-input: rgba(0, 30, 60, 0.4);
            --bg-nav: rgba(0, 20, 40, 0.98);
            --bg-overlay: rgba(0, 0, 0, 0.85);
            
            /* Текст */
            --text-primary: #f0f0f0;
            --text-secondary: #90e0ef;
            --text-muted: #aaa;
            --text-inverse: #fff;
            
            /* Границы */
            --border-color: rgba(255, 255, 255, 0.1);
            --border-radius: 12px;
            --border-radius-sm: 8px;
            
            /* Тени */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.5);
            --shadow-inset: inset 0 1px 3px rgba(0, 0, 0, 0.2);
            
            /* Эффекты */
            --glass-blur: 0px;
            --transition: all 0.2s ease;
        }
        
        /* ==================== ТЕМА: LIGHT (СВЕТЛАЯ - МЯГКИЙ БЕЖЕВЫЙ) ==================== */
        .theme-light {
            --color-primary: #8b7355;
            --color-secondary: #7a9eb1;
            --color-success: #7a9c7a;
            --color-warning: #d4a76a;
            --color-danger: #c97a7a;
            --color-accent: #d4b483;
            --color-info: #7a9eb1;
            
            --bg-body: #f5f1eb;
            --bg-header: rgba(245, 241, 235, 0.95);
            --bg-card: rgba(255, 253, 250, 0.95);
            --bg-input: rgba(255, 255, 255, 0.15);
            --bg-nav: rgba(250, 247, 242, 0.98);
            --bg-overlay: rgba(0, 0, 0, 0.1);
            
            --text-primary: #5a5349;
            --text-secondary: #7a7368;
            --text-muted: #9c968d;
            --text-inverse: #ffffff;
            
            --border-color: rgba(139, 115, 85, 0.15);
            --shadow-sm: 0 2px 12px rgba(139, 115, 85, 0.08);
            --shadow-md: 0 5px 20px rgba(139, 115, 85, 0.05);
            --shadow-lg: 0 10px 35px rgba(139, 115, 85, 0.1);
            
            /* Уникальные цвета для элементов */
            --exercise-bg: rgba(139, 115, 85, 0.1);
            --exercise-border: #8b7355;
            --weight-details-bg: rgba(139, 115, 85, 0.15);
            --exercise-note-color: #7a9c7a;
            --extra-activity-bg: rgba(122, 156, 122, 0.2);
            --extra-activity-border: #7a9c7a;

 	   /* Фон для упражнений на вкладке Упражнения */
    	    --exercise-item-bg: rgba(139, 115, 85, 0.08);
    
   	  /* Фон для кругов в таймере */
  	   --timer-laps-bg: rgba(255, 255, 255, 0.8);
       
 }

.theme-light .btn-remove-weight-set {
    background: rgba(201, 122, 122, 0.2);
    color: #c97a7a;
    border-color: rgba(201, 122, 122, 0.4);
}
.theme-light .btn-remove-weight-set:hover {
    background: rgba(201, 122, 122, 0.4);
}
        
        /* ==================== ТЕМА: PREMIUM (ПРЕМИУМ) ==================== */
        .theme-premium {
            --color-primary: #d4af37;
            --color-secondary: #b87333;
            --color-success: #2a9d8f;
            --color-warning: #e9c46a;
            --color-danger: #e76f51;
            --color-accent: #f4a261;
            --color-info: #264653;
            
            --bg-body: #121212;
            --bg-header: rgba(30, 30, 30, 0.95);
            --bg-card: rgba(40, 40, 40, 0.8);
            --bg-input: rgba(60, 60, 60, 0.6);
            --bg-nav: rgba(25, 25, 25, 0.98);
            --bg-overlay: rgba(0, 0, 0, 0.8);
            
            --text-primary: #f5f5f5;
            --text-secondary: #d4af37;
            --text-muted: #888888;
            --text-inverse: #FFFEFE;
            
            --border-color: rgba(212, 175, 55, 0.2);
            --shadow-sm: 0 2px 12px rgba(0, 0, 0, 0.5);
            --shadow-md: 0 5px 20px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 35px rgba(0, 0, 0, 0.6);
            
            /* Уникальные цвета для элементов */
            --exercise-bg: rgba(212, 175, 55, 0.15);
            --exercise-border: #d4af37;
            --weight-details-bg: rgba(212, 175, 55, 0.2);
            --exercise-note-color: #f4a261;
            --extra-activity-bg: rgba(42, 157, 143, 0.2);
            --extra-activity-border: #2a9d8f;
        }
.theme-premium .btn-remove-weight-set {
    background: rgba(231, 111, 81, 0.2);
    color: #e76f51;
    border-color: rgba(231, 111, 81, 0.4);
}

.theme-premium .btn-remove-weight-set:hover {
    background: rgba(231, 111, 81, 0.4);
}
        
        /* ==================== ОСНОВНЫЕ СТИЛИ (ОБНОВЛЕННЫЕ С CSS-ПЕРЕМЕННЫМИ) ==================== */
        body {
            background: var(--bg-body);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 60px;
            line-height: 1.4;
        }
        
        .app-header {
            background: var(--bg-header);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 2px solid var(--color-primary);
            position: relative;
        }
        
        .header-titles { text-align: left; }
        
        .app-header h1 {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-inverse);
            line-height: 1.2;
        }
        
        .app-header .subtitle {
            font-size: 0.8rem;
            opacity: 0.8;
            color: var(--text-secondary);
        }
        
        .app-header .subtitle.diary-subtitle {
            font-weight: bold;
            color: var(--color-accent);
        }
        
        .header-add-btn {
            background: var(--color-primary);
            color: white;
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            transition: all 0.2s;
            position: absolute;
            right: 60px;
        }
        
        .header-add-btn:hover {
            background: var(--color-primary);
            filter: brightness(1.2);
            transform: scale(1.05);
        }
        
        .content-area {
            padding: 12px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .workout-list {
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin-top: 10px;
        }
        
        .workout-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 14px;
            border-left: 5px solid var(--color-primary);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .workout-card[data-type="circuit"] {
            border-left-color: var(--color-success);
        }
        
        .workout-card[data-type="home"] {
            border-left-color: var(--color-warning);
        }
        
        .workout-card[data-type="other"] {
            border-left-color: var(--color-secondary);
        }
        
        .workout-date {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            padding-right: 100px;
        }
        
        .date-text {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .workout-type {
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.78rem;
            font-weight: 600;
            margin-top: 4px;
        }
        
        .type-strength {
            background-color: var(--color-primary);
        }
        
        .type-circuit {
            background-color: var(--color-success);
        }
        
        .type-home {
            background-color: var(--color-warning);
        }
        
        .type-other {
            background-color: var(--color-secondary);
        }
        
        .workout-actions {
            position: absolute;
            top: 14px;
            right: 14px;
            display: flex;
            gap: 8px;
        }
        
        .workout-copy-btn, .workout-edit-btn, .workout-delete-btn {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .workout-copy-btn:hover {
            background: var(--color-success);
            opacity: 0.3;
            color: var(--color-success);
        }
        
        .workout-edit-btn:hover {
            background: var(--color-primary);
            opacity: 0.3;
            color: var(--color-primary);
        }
        
        .workout-delete-btn:hover {
            background: var(--color-danger);
            opacity: 0.3;
            color: var(--color-danger);
        }

.theme-light .workout-copy-btn,
.theme-light .workout-edit-btn,
.theme-light .workout-delete-btn {
    background: rgba(139, 115, 85, 0.15);
    color: rgba(139, 115, 85, 0.8);
    border: 1px solid rgba(139, 115, 85, 0.2);
}

.theme-light .workout-copy-btn:hover {
    background: #7a9c7a;
    color: white;
    border-color: #7a9c7a;
}

.theme-light .workout-edit-btn:hover {
    background: #8b7355;
    color: white;
    border-color: #8b7355;
}

.theme-light .workout-delete-btn:hover {
    background: #c97a7a;
    color: white;
    border-color: #c97a7a;
}

.theme-premium .workout-copy-btn,
.theme-premium .workout-edit-btn,
.theme-premium .workout-delete-btn {
    background: rgba(212, 175, 55, 0.15);
    color: rgba(212, 175, 55, 0.8);
    border: 1px solid rgba(212, 175, 55, 0.2);
}

.theme-premium .workout-copy-btn:hover {
    background: #2a9d8f;
    color: white;
    border-color: #2a9d8f;
}

.theme-premium .workout-edit-btn:hover {
    background: #d4af37;
    color: white;
    border-color: #d4af37;
}

.theme-premium .workout-delete-btn:hover {
    background: #e76f51;
    color: white;
    border-color: #e76f51;
}
        
        .exercises-block {
            margin: 10px 0 6px 0;
        }
        
        .exercise-item {
            background: var(--exercise-bg, rgba(0, 30, 60, 0.4));
            margin: 6px 0;
            padding: 10px 12px;
            border-radius: 8px;
            border-left: 4px solid var(--exercise-border, #0077b6);
        }
        
        .exercise-item:first-child {
            margin-top: 0;
        }
        
        .exercise-item:last-child {
            margin-bottom: 0;
        }
        
        .exercise-name-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .exercise-main-name {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .exercise-number {
            color: var(--color-primary);
            font-weight: 800;
            font-size: 0.9em;
            min-width: 1.2em;
        }
        
        .exercise-spec {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-style: italic;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-width: 100%;
            display: block;
            margin-top: 4px;
        }
        
        .weight-details {
            background: var(--weight-details-bg, rgba(157, 78, 221, 0.15));
            padding: 6px 10px;
            border-radius: 6px;
            margin: 4px 0;
            font-family: monospace;
            white-space: pre-line;
            color: var(--text-primary);
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        .exercise-note {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px dashed var(--border-color);
            font-weight: 400;
            text-decoration: underline;
            color: var(--exercise-note-color, #b5e48c);
            font-size: 0.88rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-width: 100%;
            display: block;
        }
        
        .extra-activity {
            margin-top: 12px;
            padding: 8px 12px;
            background: var(--extra-activity-bg, rgba(72, 187, 120, 0.2));
            border-radius: 8px;
            border-left: 4px solid var(--extra-activity-border, #48bb78);
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .metrics {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-color);
        }
        
        .metric-value {
            font-size: 1.35rem;
            font-weight: 800;
            color: var(--color-accent);
            text-shadow: 0 0 10px rgba(var(--color-accent-rgb, 255, 209, 102), 0.5);
        }
        
        .metric-label {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 2px;
            color: var(--text-muted);
        }
        
        /* ==================== ФОРМЫ И КАРТОЧКИ ==================== */
        .form-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-overlay);
            z-index: 2000;
            overflow-y: auto;
        }
        
        .form-container {
            background: var(--bg-card);
            margin: 30px auto;
            max-width: 700px;
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-primary);
        }
        
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--color-primary);
        }
        
        .form-header h2 {
            color: var(--text-secondary);
            font-size: 1.6rem;
        }
        
        .btn-close-form {
            background: transparent;
            color: var(--text-muted);
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: color 0.3s;
        }
        
        .btn-close-form:hover {
            color: var(--text-inverse);
        }
        
        .workout-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .form-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            border-left: 4px solid var(--color-secondary);
        }
        
        .form-section h3 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row:last-child {
            margin-bottom: 0;
        }
        
        .form-group {
            flex: 1;
            min-width: 250px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: var(--transition);
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--color-secondary);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }
        
        .hint {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 5px;
        }
        
        .exercises-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .exercises-table thead th {
            padding: 12px 8px;
            text-align: left;
            color: var(--text-secondary);
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            font-size: 0.9rem;
        }
        
        .exercises-table tbody tr {
            border-bottom: 1px solid var(--border-color);
        }
        
        .exercises-table tbody tr:last-child {
            border-bottom: none;
        }
        
        .exercises-table td {
            padding: 12px 8px;
            vertical-align: top;
        }
        
        .exercise-row-actions {
            text-align: center;
        }
        
	.order-buttons {
 	   display: flex;
  	  flex-direction: row; /* Изменено с column на row */
   	 gap: 6px; /* Увеличено с 4px для горизонтального расположения */
 	   align-items: center;
 	   justify-content: center;
        }
        
        .btn-move-up, .btn-move-down {
            width: 31px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            font-size: 0.8rem;
            background: rgba(var(--color-primary-rgb, 157, 78, 221), 0.2);
            color: var(--color-primary);
            border-color: rgba(var(--color-primary-rgb, 157, 78, 221), 0.4);
        }
        
        .btn-move-up:hover {
            background: rgba(var(--color-primary-rgb, 157, 78, 221), 0.4);
            transform: translateY(-1px);
        }
        
        .btn-move-down:hover {
            background: rgba(var(--color-primary-rgb, 157, 78, 221), 0.4);
            transform: translateY(1px);
        }
        
        .btn-move-up:disabled, .btn-move-down:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: rgba(var(--color-primary-rgb, 157, 78, 221), 0.1) !important;
            border-color: rgba(var(--color-primary-rgb, 157, 78, 221), 0.2) !important;
            color: rgba(var(--color-primary-rgb, 157, 78, 221), 0.5) !important;
        }
        
        .btn-move-up:disabled:hover, .btn-move-down:disabled:hover {
            transform: none !important;
            background: rgba(var(--color-primary-rgb, 157, 78, 221), 0.1) !important;
        }
        
        .btn-remove-row {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            font-size: 0.8rem;
            background: rgba(var(--color-danger-rgb, 220, 53, 69), 0.2);
            color: var(--color-danger);
            border-color: rgba(var(--color-danger-rgb, 220, 53, 69), 0.4);
            margin-top: 4px;
        }
.btn-remove-weight-set {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
    font-size: 0.75rem;
    background: rgba(var(--color-danger-rgb, 220, 53, 69), 0.2);
    color: var(--color-danger);
    border-color: rgba(var(--color-danger-rgb, 220, 53, 69), 0.4);
    flex-shrink: 0;
}

.btn-remove-weight-set:hover {
    background: rgba(var(--color-danger-rgb, 220, 53, 69), 0.4);
    transform: translateY(-1px);
}
        
.weight-set-buttons {
    display: flex;
    gap: 4px;
    align-items: center;
    flex-shrink: 0;
}
        .btn-remove-row:hover {
            background: rgba(var(--color-danger-rgb, 220, 53, 69), 0.4);
            transform: translateY(-1px);
        }
        
        .weight-sets-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .weight-set-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .weight-set-input {
            flex: 2;
            min-width: 120px;
        }
        
        .sets-input, .reps-input {
            flex: 1;
            min-width: 60px;
        }
        
        .btn-add-weight-set {
            background: rgba(var(--color-success-rgb, 72, 187, 120), 0.2);
            color: var(--color-success);
            border: 1px solid rgba(var(--color-success-rgb, 72, 187, 120), 0.4);
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
            align-self: flex-start;
        }
        
        .btn-add-weight-set:hover {
            background: rgba(var(--color-success-rgb, 72, 187, 120), 0.4);
        }
        
        .btn-add-exercise {
            background: rgba(var(--color-success-rgb, 72, 187, 120), 0.2);
            color: var(--color-success);
            border: 1px solid var(--color-success);
            border-radius: 10px;
            padding: 12px 20px;
            margin-top: 15px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-add-exercise:hover {
            background: rgba(var(--color-success-rgb, 72, 187, 120), 0.4);
            transform: translateY(-2px);
        }
        
        .weight-bmi-row {
            display: flex;
            align-items: flex-end;
            gap: 20px;
        }
        
        .bmi-display {
            background: rgba(var(--color-accent-rgb, 255, 209, 102), 0.1);
            border: 1px solid rgba(var(--color-accent-rgb, 255, 209, 102), 0.3);
            border-radius: 10px;
            padding: 12px 15px;
            min-width: 150px;
        }
        
        .bmi-display .bmi-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--color-accent);
        }
        
        .bmi-display .bmi-label {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 3px;
            color: var(--text-muted);
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn-cancel, .btn-submit {
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-cancel:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .btn-submit {
            background: linear-gradient(to right, var(--color-secondary), var(--color-primary));
            color: white;
            border: none;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 180, 216, 0.4);
        }
        
        /* ==================== КАРТОЧКИ РАЗДЕЛОВ ==================== */
        .exercises-card, .profile-card, .graph-container, .timer-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            margin-top: 15px;
            box-shadow: var(--shadow-md);
        }
        
        .exercises-card {
            border-left: 5px solid var(--color-success);
        }
        
        .profile-card {
            border-left: 5px solid var(--color-secondary);
        }
        
        .graph-container {
            border-left: 5px solid var(--color-accent);
        }
        
        .timer-card {
            border-left: 5px solid var(--color-primary);
        }
        
        .exercises-card h2, .profile-card h2, .graph-container h3, .timer-card h2 {
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 1.4rem;
        }
        
        .exercises-card h2 i, .profile-card h2 i, .graph-container h3 i, .timer-card h2 i {
            margin-right: 10px;
        }
        
        .input-with-button {
            display: flex;
            gap: 10px;
        }
        
        .input-with-button input {
            flex: 1;
            padding: 12px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .btn-add, .btn-save {
            background: linear-gradient(to right, var(--color-success), var(--color-success));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-add:hover, .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }
        
        .exercises-list-container {
            margin-top: 20px;
        }
        
        .exercises-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .exercise-list-item {
            background: rgba(0, 30, 60, 0.4);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--color-success);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }
        
        .exercise-list-item:hover {
            background: rgba(0, 30, 60, 0.6);
        }
        
        .exercise-list-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.05rem;
        }
        
        .exercise-list-name.editing {
            display: none;
        }
        
        .exercise-list-edit-input {
            flex: 1;
            padding: 8px 12px;
            margin-right: 10px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid var(--color-success);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 1rem;
            display: none;
        }
        
        .exercise-list-edit-input.editing {
            display: block;
        }
        
        .exercise-list-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-edit, .btn-save-edit, .btn-cancel-edit, .btn-delete {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }
        
        .btn-edit {
            background: rgba(var(--color-accent-rgb, 255, 209, 102), 0.2);
            color: var(--color-accent);
            border-color: rgba(var(--color-accent-rgb, 255, 209, 102), 0.4);
        }
        
        .btn-edit:hover {
            background: rgba(var(--color-accent-rgb, 255, 209, 102), 0.3);
        }
        
        .btn-save-edit {
            background: rgba(var(--color-success-rgb, 72, 187, 120), 0.3);
            color: var(--color-success);
            border-color: var(--color-success);
            display: none;
        }
        
        .btn-save-edit:hover {
            background: rgba(var(--color-success-rgb, 72, 187, 120), 0.5);
        }
        
        .btn-cancel-edit {
            background: rgba(108, 117, 125, 0.3);
            color: var(--text-muted);
            border-color: rgba(108, 117, 125, 0.5);
            display: none;
        }
        
        .btn-cancel-edit:hover {
            background: rgba(108, 117, 125, 0.5);
        }
        
        .btn-delete {
            background: rgba(var(--color-danger-rgb, 220, 53, 69), 0.2);
            color: var(--color-danger);
            border-color: rgba(var(--color-danger-rgb, 220, 53, 69), 0.4);
        }
        
        .btn-delete:hover {
            background: rgba(var(--color-danger-rgb, 220, 53, 69), 0.4);
        }
        
        .empty-list-message {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            font-style: italic;
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            background: rgba(0,0,0,0.2);
        }
        
        .graph-placeholder {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-muted);
            font-style: italic;
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            background: rgba(0,0,0,0.2);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 9999;
            font-size: 0.95rem;
            box-shadow: var(--shadow-lg);
            display: none;
        }
        
        /* ==================== НИЖНЕЕ МЕНЮ ==================== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-nav);
            display: flex;
            justify-content: space-around;
            padding: 12px 5px;
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-secondary);
            text-decoration: none;
            padding: 8px 5px;
            border-radius: 10px;
            transition: all 0.3s;
            flex: 1;
            max-width: 90px;
        }
        
        .nav-item.active {
            background: rgba(var(--color-primary-rgb, 157, 78, 221), 0.25);
            color: var(--text-inverse);
        }
        
        .nav-item i {
            font-size: 1.3rem;
            margin-bottom: 4px;
        }
        
        .nav-item span {
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-muted);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--text-muted);
        }
        
        .empty-state p {
            color: var(--text-muted);
        }
        
        /* ==================== БЛОК ПЕРЕКЛЮЧАТЕЛЯ ТЕМ (В ПРОФИЛЕ) ==================== */
        .theme-selector-card {
    background: var(--bg-card);
    border-radius: 16px;
    padding: 16px 20px;
    margin-top: 15px;
    box-shadow: var(--shadow-md);
    border-left: 5px solid var(--color-primary);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 15px;
}

/* Заголовок в одну строку с иконками */
.theme-selector-card h2 {
    color: var(--text-secondary);
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 0;
    white-space: nowrap;
}

.theme-selector-card h2 i {
    margin-right: 0;
}

/* Контейнер с кнопками тем - в одну строку */
.theme-buttons-container {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-shrink: 0;
}

/* Кнопки тем - компактные */
.theme-btn {
    width: 38px;
    height: 38px;
    border-radius: 8px;
    border: 2px solid transparent;
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    flex-shrink: 0;
}

.theme-btn:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
}

.theme-btn.active {
    background: var(--color-primary);
    color: var(--text-inverse);
    border-color: var(--color-primary);
    box-shadow: var(--shadow-sm);
}

/* Адаптивность для маленьких экранов */
@media (max-width: 768px) {
    .theme-selector-card {
        padding: 14px 16px;
        gap: 12px;
    }
    
    .theme-selector-card h2 {
        font-size: 1rem;
    }
    
    .theme-btn {
        width: 34px;
        height: 34px;
        font-size: 0.9rem;
    }
    
    .theme-buttons-container {
        gap: 8px;
    }
}

@media (max-width: 480px) {
    .theme-selector-card {
        padding: 12px 14px;
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
    }
    
    .theme-selector-card h2 {
        justify-content: center;
        text-align: center;
    }
    
    .theme-buttons-container {
        justify-content: center;
    }
    
    .theme-btn {
        width: 36px;
        height: 36px;
        font-size: 0.95rem;
    }
.order-buttons {
        width: 100%;
        justify-content: space-around;
    }
}
        
        /* ==================== ГРАФИК ВЕСА ==================== */
        .graph-controls {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(var(--color-primary-rgb, 157, 78, 221), 0.3);
        }
        
        .period-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .period-btn {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 100px;
            text-align: center;
        }
        
        .period-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .period-btn.active {
            background: linear-gradient(135deg, var(--color-secondary), var(--color-primary));
            color: white;
            border-color: var(--color-secondary);
            box-shadow: 0 4px 12px rgba(0, 180, 216, 0.4);
        }
        
        .extremes-info {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            font-size: 0.95rem;
            color: var(--text-primary);
        }
        
        .extremes-min, .extremes-max {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .extremes-min i {
            color: var(--color-success);
        }
        
        .extremes-max i {
            color: var(--color-danger);
        }
        
        .extremes-min span, .extremes-max span {
            font-weight: 800;
            font-size: 1.1rem;
            color: var(--text-inverse);
        }
        
        /* ==================== ТАЙМЕР ==================== */
        .timer-display {
            font-size: 5rem;
            font-weight: 800;
            color: var(--color-accent);
            margin: 20px 0;
            text-shadow: 0 0 20px rgba(255, 209, 102, 0.5);
            line-height: 1;
            text-align: center;
        }
        
        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .timer-btn {
            padding: 15px 25px;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 140px;
            justify-content: center;
        }
        
        .timer-btn-start {
            background: linear-gradient(135deg, var(--color-success), var(--color-success));
            color: white;
        }
        
        .timer-btn-start:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(72, 187, 120, 0.4);
        }
        
        .timer-btn-lap {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary));
            color: white;
        }
        
        .timer-btn-lap:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(157, 78, 221, 0.4);
        }
        
        .timer-btn-reset {
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .timer-btn-reset:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-3px);
        }
        
        .timer-laps {
            margin-top: 30px;
        }
        
        .timer-laps h3 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.3rem;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .laps-container {
            max-height: 300px;
            overflow-y: auto;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
        }
        
        .lap-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--color-secondary);
            transition: background 0.3s;
        }
        
        .lap-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .lap-number {
            color: var(--color-primary);
            font-weight: 800;
            font-size: 1.1rem;
            min-width: 40px;
        }
        
        .lap-time {
            font-family: monospace;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--color-accent);
        }
        
        .empty-laps {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
            font-style: italic;
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            background: rgba(0,0,0,0.2);
        }
        
        .timer-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed var(--border-color);
        }
        
        .stat-box {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-secondary);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 5px;
        }
        
        /* ==================== КНОПКИ ЭКСПОРТА/ИМПОРТА ==================== */
        .btn-export, .btn-import {
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 200px;
            justify-content: center;
        }
        
        .btn-export {
            background: linear-gradient(135deg, var(--color-success), var(--color-success));
            color: white;
        }
        
        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }
        
        .btn-import {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary));
            color: white;
        }
        
        .btn-import:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(157, 78, 221, 0.4);
        }
        
        /* Модальные окна */
        .import-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-overlay);
            z-index: 3000;
            overflow-y: auto;
        }
        
        .import-modal-content {
            background: var(--bg-card);
            margin: 50px auto;
            max-width: 600px;
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow-lg);
            border: 2px solid var(--color-primary);
        }
        
        .import-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }
        
        .import-option {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--color-secondary);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .import-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .import-option input[type="radio"] {
            margin-right: 10px;
        }
        
        .import-option label {
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
        }
        
        /* ==================== ОФЛАЙН-РЕЖИМ ==================== */
        .offline-warning {
            display: none;
            background: linear-gradient(135deg, rgba(var(--color-danger-rgb, 255, 107, 107), 0.9), rgba(238, 90, 82, 0.9));
            color: white;
            padding: 10px 15px;
            text-align: center;
            font-weight: bold;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 25;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            pointer-events: none;
        }
        
        .offline .offline-warning {
            display: block;
        }
        
        /* Версия приложения */
        .app-version {
            position: absolute;
            right: 1px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
            font-size: 0.45rem;
            color: rgba(255, 255, 255, 0.4);
            font-weight: 600;
            letter-spacing: 1px;
            user-select: none;
            pointer-events: none;
            font-family: 'Segoe UI', system-ui, sans-serif;
            white-space: nowrap;
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* ==================== СПЕЦИФИЧНЫЕ СТИЛИ ДЛЯ ПОЛЕЙ ==================== */
        .exercise-note-input {
            width: 100%;
            min-height: 38px;
            max-height: 200px;
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: 'Segoe UI', system-ui, sans-serif;
            resize: none;
            overflow-y: hidden;
            line-height: 1.4;
            transition: var(--transition);
            box-sizing: border-box;
        }
        
        .exercise-note-input:focus {
            outline: none;
            border-color: var(--color-secondary);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .exercises-table input,
        .exercises-table select,
        .exercises-table textarea {
            width: 100%;
            min-height: 38px;
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            box-sizing: border-box;
            transition: var(--transition);
        }
        
        .exercises-table input:focus,
        .exercises-table select:focus,
        .exercises-table textarea:focus {
            outline: none;
            border-color: var(--color-secondary);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 2px rgba(0, 180, 216, 0.1);
        }
        
        .exercise-name-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 35px;
            cursor: pointer;
        }
/* ==================== ИСПРАВЛЕНИЯ ДЛЯ СВЕТЛОЙ ТЕМЫ ==================== */

/* Фон для упражнений в базе упражнений */
.theme-light .exercise-list-item {
    background: rgba(139, 115, 85, 0.08) !important;
    border-left: 4px solid var(--color-success);
}

.theme-light .exercise-list-item:hover {
    background: rgba(139, 115, 85, 0.15) !important;
}

/* Фон для контейнера кругов в таймере */
.theme-light .laps-container {
    background: rgba(255, 255, 255, 0.8) !important;
    border: 1px solid rgba(139, 115, 85, 0.1);
}

/* Фон для отдельных кругов (лапов) */
.theme-light .lap-item {
    background: rgba(255, 255, 255, 0.9) !important;
    border-left: 4px solid var(--color-secondary);
}

.theme-light .lap-item:hover {
    background: rgba(255, 255, 255, 1) !important;
}

/* Фон для пустого состояния кругов */
.theme-light .empty-laps {
    background: rgba(255, 255, 255, 0.9) !important;
    border: 2px dashed rgba(139, 115, 85, 0.2);
    color: var(--text-muted);
}        

        /* ==================== АДАПТИВНОСТЬ ==================== */
        @media (max-width: 768px) {
            .theme-btn {
                width: 50px;
                height: 50px;
                font-size: 1.3rem;
            }
            
            .form-container {
                margin: 10px;
                padding: 20px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .form-group {
                min-width: 100%;
            }
            
            .exercises-table thead {
                display: none;
            }
            
            .exercises-table tbody tr {
                display: flex;
                flex-direction: column;
                margin-bottom: 20px;
                padding: 15px;
                background: rgba(255,255,255,0.05);
                border-radius: 10px;
            }
            
            .exercises-table td {
                display: block;
                padding: 8px 0;
                border: none;
            }
            
            .exercises-table td:before {
                content: attr(data-label);
                font-weight: 600;
                color: var(--text-secondary);
                display: block;
                margin-bottom: 5px;
                font-size: 0.9rem;
            }
            
            .exercise-row-actions {
                text-align: left;
                margin-top: 10px;
display: flex;
        justify-content: flex-start;
            }
 	    
  	    .order-buttons {
        flex-wrap: wrap;
        gap: 4px;
    }            

            .input-with-button {
                flex-direction: column;
            }
            
            .weight-bmi-row {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .exercise-list-actions {
                flex-wrap: wrap;
            }
            
            .weight-set-row {
                flex-direction: column;
                align-items: stretch;
		gap: 8px;
            }
            
            .weight-set-input, .sets-input, .reps-input {
                min-width: 100%;
            }

 .weight-set-buttons {
        width: 100%;
        justify-content: center;
        margin-top: 5px;
    }

.btn-remove-weight-set, .btn-add-weight-set {
        width: 32px;
        height: 32px;
        font-size: 0.85rem;
    }
            
            .workout-date {
                padding-right: 90px;
            }
            
            .btn-export, .btn-import {
                min-width: 100%;
            }
            
            .period-filters {
                flex-direction: column;
            }
            
            .period-btn {
                min-width: 100%;
            }
            
            .extremes-info {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .timer-display {
                font-size: 3.5rem;
            }
            
            .timer-btn {
                min-width: 120px;
                padding: 12px 20px;
                font-size: 1rem;
            }
            
            .timer-controls {
                gap: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .theme-btn {
                width: 45px;
                height: 45px;
                font-size: 1.2rem;
            }
            
            .app-header {
                padding-right: 70px;
            }
            
            .header-add-btn {
                right: 35px;
            }
            
            .timer-display {
                font-size: 2.8rem;
            }
            
            .timer-btn {
                min-width: 100%;
                margin-bottom: 10px;
            }
            
            .timer-controls {
                flex-direction: column;
            }
            
            .timer-stats {
                flex-direction: column;
                gap: 20px;
            }
        }
        
        @media (max-width: 400px) {
            .theme-buttons-container {
                gap: 10px;
            }
            
            .theme-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .workout-date {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
            
            .exercise-name-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 3px;
            }
            
            .metrics {
                flex-direction: column;
                gap: 12px;
            }
            
            .workout-actions {
                top: 10px;
                right: 10px;
            }
            
            .workout-date {
                padding-right: 80px;
            }
            
            .app-version {
                display: none;
            }
            
            .app-header {
                padding-right: 60px;
            }
            
            .header-add-btn {
                right: 15px;
            }
        }
        
        @media (max-width: 320px) {
            .theme-buttons-container {
                gap: 8px;
            }
            
            .theme-btn {
                width: 36px;
                height: 36px;
                font-size: 0.9rem;
            }
            
            .metrics {
                flex-direction: row;
                flex-wrap: nowrap;
                justify-content: space-between;
            }
            
            .metric {
                min-width: 70px;
            }
            
            .metric-value {
                font-size: 1rem;
            }
            
            .workout-type {
                font-size: 0.6rem;
                padding: 2px 4px;
            }
        }
    </style>
</head>
<body class="theme-dark">
    <!-- ШАПКА -->
    <header class="app-header">
        <div class="header-titles">
            <h1 id="pageTitle">🏋️ Мой Дневник Тренировок</h1>
            <div class="subtitle" id="pageSubtitle">Сила в дисциплине. Прресс в деталях.</div>
        </div>
        <button class="header-add-btn" id="globalAddBtn" title="Добавить новую тренировку">+</button>
        <div class="app-version" id="appVersion">V2.3.2</div>
    </header>
    
    <div class="offline-warning" id="offlineWarning">
        <i class="fas fa-wifi-slash"></i> Вы в офлайн-режиме. Данные сохраняются локально.
    </div>
    
    <!-- ОСНОВНОЙ КОНТЕНТ -->
    <main class="content-area">
        <!-- ВКЛАДКА ДНЕВНИКА -->
        <section id="workoutSection">
            <div class="workout-list" id="workoutListContainer">
                <div class="empty-state" id="workoutEmptyState">
                    <i class="fas fa-dumbbell"></i>
                    <h3>Записей пока нет</h3>
                    <p>Нажмите кнопку "+" в шапке, чтобы добавить первую тренировку!</p>
                </div>
            </div>
        </section>

        <!-- ВКЛАДКА УПРАЖНЕНИЙ -->
        <section id="exercisesSection" style="display: none;">
            <div class="exercises-card">
                <h2><i class="fas fa-list-check"></i> Моя база упражнений</h2>
                <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 0.95rem;">
                    Добавляйте сюда упражнения, которые часто выполняете.
                </p>
                <form class="exercise-form" id="exerciseForm">
                    <div class="input-with-button">
                        <input type="text" id="newExerciseInput" placeholder="Например: Подтягивания..." required>
                        <button type="submit" class="btn-add"><i class="fas fa-plus-circle"></i> Добавить</button>
                    </div>
                </form>
                <div class="exercises-list-container">
                    <ul class="exercises-list" id="exercisesList">
                        <li class="empty-list-message" id="emptyExercisesList">
                            <i class="fas fa-dumbbell"></i>
                            <strong>База упражнений пуста</strong><br>
                            Добавьте первое упражнение.
                        </li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- ВКЛАДКА ПРОФИЛЯ -->
        <section id="profileSection" style="display: none;">
            <!-- БЛОК ПЕРЕКЛЮЧАТЕЛЯ ТЕМ -->
       <div class="theme-selector-card">
    <h2><i class="fas fa-palette"></i>Выбор темы оформления:</h2>
    <div class="theme-buttons-container">
        <button class="theme-btn active" data-theme="dark" title="Тёмная тема">
            <i class="fas fa-moon"></i>
        </button>
        <button class="theme-btn" data-theme="light" title="Светлая тема">
            <i class="fas fa-sun"></i>
        </button>
        <button class="theme-btn" data-theme="premium" title="Премиум тема">
            <i class="fas fa-crown"></i>
        </button>
    </div>
</div>

            <!-- БЛОК ЛИЧНЫХ ДАННЫХ -->
            <div class="profile-card">
                <h2><i class="fas fa-user-circle"></i> Личные данные</h2>
                <form class="profile-form" id="profileForm">
                    <div class="form-group">
                        <label for="profileUserName">Ваше имя *</label>
                        <input type="text" id="profileUserName" placeholder="Например, Иван" required>
                    </div>
                    <div class="form-group">
                        <label for="profileUserHeight">Рост (см) *</label>
                        <input type="number" id="profileUserHeight" placeholder="166" min="100" max="250" step="0.1" required>
                        <div class="hint">Для расчёта BMI</div>
                    </div>
                    <button type="submit" class="btn-save"><i class="fas fa-save"></i> Сохранить профиль</button>
                </form>
            </div>
            
            <!-- БЛОК ЭКСПОРТА/ИМПОРТА ДАННЫХ -->
            <div class="profile-card" style="margin-top: 15px;">
                <h2><i class="fas fa-file-export"></i> Управление данными</h2>
                <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 0.95rem;">
                    Экспортируйте все данные в JSON-файл или импортируйте из резервной копии.
                </p>
                
                <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;">
                    <button class="btn-export" id="exportAllBtn">
                        <i class="fas fa-download"></i> Экспорт всех данных
                    </button>
                    
                    <button class="btn-import" id="importBtn">
                        <i class="fas fa-upload"></i> Импорт данных 
                    </button>
                    
                    <button class="btn-export" id="exportReportBtn" style="background: linear-gradient(135deg, var(--color-secondary), var(--color-primary));">
                        <i class="fas fa-file-alt"></i> Создать текстовый отчет
                    </button>   
                    
                    <input type="file" id="importFileInput" accept=".json" style="display: none;">
                </div>
                
                <div class="hint" style="color: var(--color-accent); background: rgba(var(--color-accent-rgb, 255, 209, 102), 0.1); padding: 10px; border-radius: 8px; font-size: 0.85rem;">
                    <strong><i class="fas fa-info-circle"></i> Важно:</strong> При импорте данные могут быть перезаписаны. 
                    Рекомендуется сначала сделать экспорт текущих данных.
                </div>
            </div>
            
            <!-- ГРАФИК ВЕСА -->
            <div class="graph-container">
                <h3><i class="fas fa-chart-line"></i> Динамика веса</h3>
                <div id="weightChart">
                    <div class="graph-controls">
                        <div class="period-filters">
                            <button class="period-btn active" data-period="all">Всё время</button>
                            <button class="period-btn" data-period="year">Год</button>
                            <button class="period-btn" data-period="3month">3 месяца</button>
                            <button class="period-btn" data-period="30days">30 дней</button>
                        </div>
                        <div class="extremes-info" id="extremesInfo" style="display: none;">
                            <span class="extremes-min"><i class="fas fa-arrow-down"></i> Мин: <span id="extremeMinValue">-</span> кг</span>
                            <span class="extremes-max"><i class="fas fa-arrow-up"></i> Макс: <span id="extremeMaxValue">-</span> кг</span>
                        </div>
                    </div>
                    
                    <div class="graph-placeholder" id="chartPlaceholder">
                        <i class="fas fa-weight-scale" style="font-size: 2.5rem; margin-bottom: 10px; opacity: 0.5;"></i><br>
                        <strong>Данные для графика появятся здесь</strong><br>
                        Добавьте тренировки с указанием веса.
                    </div>
                    <canvas id="weightChartCanvas"></canvas>
                </div>
            </div>
        </section>

        <!-- ВКЛАДКА ТАЙМЕРА -->
        <section id="timerSection" style="display: none;">
            <div class="timer-card">
                <h2><i class="fas fa-stopwatch"></i> Секундомер</h2>
                
                <div class="timer-display" id="timerDisplay">00:00</div>
                
                <!-- ПАНЕЛЬ УПРАВЛЕНИЯ -->
                <div class="timer-controls">
                    <button class="timer-btn timer-btn-start" id="startPauseBtn">
                        <i class="fas fa-play"></i> Старт
                    </button>
                    <button class="timer-btn timer-btn-lap" id="lapBtn" disabled>
                        <i class="fas fa-flag"></i> Круг
                    </button>
                    <button class="timer-btn timer-btn-reset" id="resetBtn" disabled>
                        <i class="fas fa-redo"></i> Сброс
                    </button>
                </div>
                
                <!-- СПИСОК КРУГОВ -->
                <div class="timer-laps">
                    <h3><i class="fas fa-list-ol"></i> Круги</h3>
                    <div class="laps-container" id="lapsContainer">
                        <div class="empty-laps" id="emptyLaps">
                            <i class="fas fa-flag"></i><br>
                            <strong>Кругов пока нет</strong><br>
                            Нажмите кнопку "Круг" во время работы таймера.
                        </div>
                    </div>
                </div>
                
                <!-- СТАТИСТИКА -->
                <div class="timer-stats">
                    <div class="stat-box">
                        <div class="stat-value" id="totalLaps">0</div>
                        <div class="stat-label">Всего кругов</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="fastestLap">--:--</div>
                        <div class="stat-label">Самый быстрый круг</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="slowestLap">--:--</div>
                        <div class="stat-label">Самый медленный круг</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- ФОРМА ТРЕНИРОВКИ -->
    <div class="form-overlay" id="newWorkoutFormOverlay">
        <div class="form-container">
            <div class="form-header">
                <h2><i class="fas fa-plus-circle"></i> <span id="formTitle">Новая тренировка</span></h2>
                <button class="btn-close-form" id="closeFormBtn">&times;</button>
            </div>
            <form class="workout-form" id="newWorkoutForm">
                <input type="hidden" id="workoutId" value="">
                <input type="hidden" id="isEditMode" value="false">
                
                <div class="form-section">
                    <h3><i class="far fa-calendar"></i> Дата и тип</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="workoutDate">Дата тренировки *</label>
                            <input type="text" id="workoutDate" placeholder="ДД.ММ.ГГГГ" required>
                            <div class="hint">Формат: день.месяц.год</div>
                        </div>
                        <div class="form-group">
                            <label for="workoutType">Тип тренировки *</label>
                            <select id="workoutType" required>
                                <option value="" disabled selected>Выберите тип...</option>
                                <option value="strength">Силовая в зале</option>
                                <option value="circuit">Круговая</option>
                                <option value="home">Домашняя</option>
                                <option value="other">Другое (указать)</option>
                            </select>
                            <input type="text" id="workoutTypeOther" placeholder="Введите свой вариант" style="margin-top: 10px; display: none;">
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3><i class="fas fa-dumbbell"></i> Упражнения</h3>
                    <table class="exercises-table" id="exercisesTable">
                        <thead>
                            <tr>
                                <th style="width: 30%;">Упражнение</th>
                                <th style="width: 20%;">Спецификация</th>
                                <th style="width: 35%;">Вес/Подходы</th>
                                <th style="width: 10%;">Примечание</th>
                                <th style="width: 5%;"></th>
                            </tr>
                        </thead>
                        <tbody id="exercisesTableBody">
                        </tbody>
                    </table>
                    <button type="button" class="btn-add-exercise" id="addExerciseRowBtn">
                        <i class="fas fa-plus"></i> Добавить упражнение
                    </button>
                </div>
                <div class="form-section">
                    <h3><i class="fas fa-swimming-pool"></i> Дополнительная активность</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="extraActivityType">Тип активности</label>
                            <select id="extraActivityType">
                                <option value="" selected>Не выбрано</option>
                                <option value="Бассейн (тренировка)">Бассейн (тренировка)</option>
                                <option value="Бассейн (свободное плавание)">Бассейн (свободное плавание)</option>
                                <option value="other">Другое...</option>
                            </select>
                            <input type="text" id="extraActivityOther" placeholder="Опишите активность" style="margin-top: 10px; display: none;">
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3><i class="fas fa-weight-scale"></i> Вес и Индекс BMI</h3>
                    <div class="weight-bmi-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="workoutWeight">Вес после тренировки (кг)</label>
                            <input type="number" id="workoutWeight" placeholder="Например, 70.0" step="0.1" min="30" max="200">
                            <div class="hint">Оставьте пустым, если не взвешивались.</div>
                        </div>
                        <div class="bmi-display">
                            <div class="bmi-value" id="bmiValue">-</div>
                            <div class="bmi-label">Индекс BMI</div>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" id="cancelFormBtn">Отмена</button>
                    <button type="submit" class="btn-submit"><i class="fas fa-save"></i> <span id="submitButtonText">Сохранить тренировку</span></button>
                </div>
            </form>
        </div>
    </div>

  <!-- МОДАЛЬНОЕ ОКНО ПОДТВЕРЖДЕНИЯ ИМПОРТА -->
<div class="import-modal" id="importModal">
    <div class="import-modal-content">
        <div class="form-header">
            <h2><i class="fas fa-file-import"></i> Импорт данных</h2>
            <button class="btn-close-form" id="closeImportModal">&times;</button>
        </div>
        
        <div id="importSummary" style="display: none;">
            <div style="background: rgba(var(--color-accent-rgb, 255, 209, 102), 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: var(--color-accent); margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Обнаружены данные:</h3>
                <div id="importStats" style="color: var(--text-muted);"></div>
            </div>
        </div>
        
        <div class="import-options">
            <div class="import-option">
                <input type="radio" id="importOptionFull" name="importOption" value="full" checked>
                <label for="importOptionFull">Полный импорт (заменить все данные)</label>
                <div class="hint">Заменяет все текущие данные на импортируемые.</div>
            </div>
            
            <div class="import-option">
                <input type="radio" id="importOptionMerge" name="importOption" value="merge">
                <label for="importOptionMerge">Объединить (добавить новые тренировки)</label>
                <div class="hint">Добавит новые тренировки, сохранив существующие.</div>
            </div>
            
            <div class="import-option">
                <input type="radio" id="importOptionExercises" name="importOption" value="exercises">
                <label for="importOptionExercises">Только упражнения</label>
                <div class="hint">Обновит только базу упражнений.</div>
            </div>
        </div>
        
        <div class="form-actions" style="margin-top: 30px;">
            <button type="button" class="btn-cancel" id="cancelImportBtn">Отмена</button>
            <button type="button" class="btn-submit" id="confirmImportBtn">Подтвердить импорт</button>
        </div>
    </div>
</div>

    <!-- МЕНЮ -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-target="workoutSection">
            <i class="fas fa-dumbbell"></i><span>Дневник</span>
        </a>
        <a href="#" class="nav-item" data-target="exercisesSection">
            <i class="fas fa-list-check"></i><span>Упражнения</span>
        </a>
        <a href="#" class="nav-item" data-target="profileSection">
            <i class="fas fa-user-circle"></i><span>Профиль</span>
        </a>
        <a href="#" class="nav-item" data-target="timerSection">
            <i class="fas fa-stopwatch"></i><span>Таймер</span>
        </a>
    </nav>

    <!-- УВЕДОМЛЕНИЯ -->
    <div class="notification" id="notification"></div>

    <!-- МОДАЛЬНОЕ ОКНО ОТЧЕТА -->
    <div class="import-modal" id="reportModal">
        <div class="import-modal-content">
            <div class="form-header">
                <h2><i class="fas fa-file-export"></i> Создание текстового отчета</h2>
                <button class="btn-close-form" id="closeReportModal">&times;</button>
            </div>
            
            <div class="form-section">
                <h3><i class="fas fa-calendar-alt"></i> Выберите период</h3>
                
                <div class="import-options">
                    <div class="import-option">
                        <input type="radio" id="periodAll" name="reportPeriod" value="all" checked>
                        <label for="periodAll">Все тренировки</label>
                        <div class="hint">Создать отчет по всем записям в дневнике.</div>
                    </div>
                    
                    <div class="import-option">
                        <input type="radio" id="periodWeek" name="reportPeriod" value="week">
                        <label for="periodWeek">За последнюю неделю</label>
                        <div class="hint">Тренировки за последние 7 дней.</div>
                    </div>
                    
                    <div class="import-option">
                        <input type="radio" id="periodMonth" name="reportPeriod" value="month">
                        <label for="periodMonth">За последний месяц</label>
                        <div class="hint">Тренировки за последние 30 дней.</div>
                    </div>
                    
                    <div class="import-option">
                        <input type="radio" id="periodCustom" name="reportPeriod" value="custom">
                        <label for="periodCustom">Произвольный период</label>
                        <div class="hint">Укажите начальную и конечную дату.</div>
                    </div>
                </div>
                
                <div id="customDatesContainer" style="display: none; margin-top: 20px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reportDateFrom">Дата с</label>
                            <input type="text" id="reportDateFrom" placeholder="ДД.ММ.ГГГГ">
                        </div>
                        <div class="form-group">
                            <label for="reportDateTo">Дата по</label>
                            <input type="text" id="reportDateTo" placeholder="ДД.ММ.ГГГГ" value="">
                        </div>
                    </div>
                    <div class="hint">Формат даты: день.месяц.год (например, 15.05.2023)</div>
                </div>
            </div>
            
            <div class="form-actions" style="margin-top: 30px;">
                <button type="button" class="btn-cancel" id="cancelReportBtn">Отмена</button>
                <button type="button" class="btn-submit" id="generateReportBtn">Создать отчет</button>
            </div>
        </div>
    </div>

    <!-- СКРИПТ -->
    <script>
        // Константы
        const STORAGE_KEYS = {
            PROFILE: 'workoutDiary_userProfile',
            WORKOUTS: 'workoutDiary_workoutLog',
            EXERCISES: 'workoutDiary_exerciseBase',
            ACTIVE_TAB: 'workoutDiary_activeTab',
            TIMER_STATE: 'workoutTimer_state',
            THEME: 'workoutDiary_theme' // НОВОЕ: ключ для хранения темы
        };
        
        // Константа версии формата данных
        const DATA_FORMAT_VERSION = '1.0';
        
        // Глобальные переменные
        let exerciseRowCounter = 0;
        let weightChart = null;
      
        // ==================== СИСТЕМА ТЕМ ОФОРМЛЕНИЯ ====================
        
        // Инициализация темы
        function initTheme() {
            const savedTheme = localStorage.getItem(STORAGE_KEYS.THEME) || 'dark';
            setTheme(savedTheme);
        }
        
        // Установка темы
        function setTheme(themeName) {
            // Удаляем все классы тем
            document.body.classList.remove('theme-dark', 'theme-light', 'theme-premium');
            
            // Добавляем выбранную тему
            document.body.classList.add(`theme-${themeName}`);
            
            // Обновляем активные кнопки
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.theme === themeName) {
                    btn.classList.add('active');
                }
            });
            
            // Сохраняем в localStorage
            localStorage.setItem(STORAGE_KEYS.THEME, themeName);
            
            // Обновляем цвет темы для мобильных приложений
            updateThemeColor(themeName);
        }
        
        // Обновление мета-тега theme-color
        function updateThemeColor(themeName) {
            const themeColors = {
                'dark': '#9d4edd',
                'light': '#8b7355',
                'premium': '#d4af37'
            };
            
            const metaThemeColor = document.querySelector('meta[name="theme-color"]');
            if (metaThemeColor) {
                metaThemeColor.content = themeColors[themeName] || '#9d4edd';
            }
        }
        
        // Инициализация переключателя тем
        function initThemeSwitcher() {
            const themeButtons = document.querySelectorAll('.theme-btn');
            
            themeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const theme = this.dataset.theme;
                    setTheme(theme);
                    showNotification(`Тема изменена на ${theme === 'dark' ? 'тёмную' : theme === 'light' ? 'светлую' : 'премиум'}`);
                });
            });
        }
        
        // ==================== ТАЙМЕР ====================
        let timerInterval = null;
        let isRunning = false;
        let laps = [];
        let currentLapStartTime = 0;
        let currentLapElapsedTime = 0;
        let wakeLock = null;
        
        // Элементы таймера
        const timerDisplay = document.getElementById('timerDisplay');
        const startPauseBtn = document.getElementById('startPauseBtn');
        const lapBtn = document.getElementById('lapBtn');
        const resetBtn = document.getElementById('resetBtn');
        const lapsContainer = document.getElementById('lapsContainer');
        const emptyLaps = document.getElementById('emptyLaps');
        const totalLapsEl = document.getElementById('totalLaps');
        const fastestLapEl = document.getElementById('fastestLap');
        const slowestLapEl = document.getElementById('slowestLap');
        
        // Функции таймера (остаются без изменений)
   async function requestWakeLock() {
    try {
        // Проверяем поддержку Wake Lock API
        if ('wakeLock' in navigator) {
            // Современный синтаксис Wake Lock API
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('Wake Lock активирован - экран не будет гаснуть');
            
            wakeLock.addEventListener('release', () => {
                console.log('Wake Lock освобождён');
                wakeLock = null;
            });
        } else {
            console.warn('Wake Lock API не поддерживается в этом браузере');
            // Попробуем альтернативный метод для iOS
            if (typeof window.keepAwake !== 'undefined') {
                window.keepAwake();
            }
        }
    } catch (err) {
        console.error('Ошибка при запросе Wake Lock:', err.message || err);
    }
}
        
        function releaseWakeLock() {
    if (wakeLock !== null) {
        wakeLock.release()
            .then(() => {
                console.log('Wake Lock освобождён успешно');
                wakeLock = null;
            })
            .catch(err => {
                console.error('Ошибка при освобождении Wake Lock:', err);
            });
    }
}
        
        function updateTimerDisplay() {
            const currentLapTime = currentLapElapsedTime + (isRunning ? Date.now() - currentLapStartTime : 0);
            const minutes = Math.floor((currentLapTime / 60000) % 60);
            const seconds = Math.floor((currentLapTime / 1000) % 60);
            
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function formatLapTime(ms) {
            const minutes = Math.floor((ms / 60000) % 60);
            const seconds = Math.floor((ms / 1000) % 60);
            
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function renderLaps() {
            const container = document.getElementById('lapsContainer');
            
            const existingLaps = container.querySelectorAll('.lap-item');
            existingLaps.forEach(lap => lap.remove());
            
            if (laps.length === 0) {
                if (emptyLaps) emptyLaps.style.display = 'block';
                return;
            }
            
            if (emptyLaps) emptyLaps.style.display = 'none';
            
            for (let i = laps.length - 1; i >= 0; i--) {
                const lap = laps[i];
                const lapItem = document.createElement('div');
                lapItem.className = 'lap-item';
                lapItem.innerHTML = `
                    <div class="lap-number">#${i + 1}</div>
                    <div class="lap-time">${formatLapTime(lap.time)}</div>
                `;
                container.appendChild(lapItem);
            }
        }
        
        function updateStats() {
            totalLapsEl.textContent = laps.length;
            
            if (laps.length > 0) {
                const lapTimes = laps.map(lap => lap.time);
                const fastest = Math.min(...lapTimes);
                const slowest = Math.max(...lapTimes);
                
                fastestLapEl.textContent = formatLapTime(fastest);
                slowestLapEl.textContent = formatLapTime(slowest);
            } else {
                fastestLapEl.textContent = '--:--';
                slowestLapEl.textContent = '--:--';
            }
        }
        
        async function toggleTimer() {
            if (isRunning) {
                clearInterval(timerInterval);
                const now = Date.now();
                currentLapElapsedTime += now - currentLapStartTime;
                startPauseBtn.innerHTML = '<i class="fas fa-play"></i> Старт';
                lapBtn.disabled = true;
                resetBtn.disabled = false;
                
                releaseWakeLock();
            } else {
                currentLapStartTime = Date.now();
                timerInterval = setInterval(updateTimerDisplay, 10);
                startPauseBtn.innerHTML = '<i class="fas fa-pause"></i> Пауза';
                lapBtn.disabled = false;
                resetBtn.disabled = true;
                
                await requestWakeLock();
            }
            
            isRunning = !isRunning;
            saveTimerState();
        }
        
        function addLap() {
            if (!isRunning) return;
            
            const now = Date.now();
            const lapTime = currentLapElapsedTime + (now - currentLapStartTime);
            
            laps.push({
                time: lapTime,
                timestamp: now
            });
            
            currentLapElapsedTime = 0;
            currentLapStartTime = now;
            
            renderLaps();
            updateStats();
            updateTimerDisplay();
            saveTimerState();
        }
        
        function resetTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            currentLapElapsedTime = 0;
            currentLapStartTime = 0;
            laps = [];
            
            startPauseBtn.innerHTML = '<i class="fas fa-play"></i> Старт';
            lapBtn.disabled = true;
            resetBtn.disabled = true;
            
            releaseWakeLock();
            
            updateTimerDisplay();
            renderLaps();
            updateStats();
            saveTimerState();
        }
        
        function saveTimerState() {
            const state = {
                isRunning: isRunning,
                currentLapStartTime: currentLapStartTime,
                currentLapElapsedTime: currentLapElapsedTime,
                laps: laps,
                savedAt: Date.now()
            };
            
            try {
                localStorage.setItem(STORAGE_KEYS.TIMER_STATE, JSON.stringify(state));
            } catch (error) {
                console.error('Ошибка сохранения состояния таймера:', error);
            }
        }
        
        async function loadTimerState() {
            try {
                const saved = localStorage.getItem(STORAGE_KEYS.TIMER_STATE);
                if (saved) {
                    const state = JSON.parse(saved);
                    
                    const now = Date.now();
                    const savedAt = state.savedAt || 0;
                    const hoursSinceSave = (now - savedAt) / (1000 * 60 * 60);
                    
                    if (hoursSinceSave < 24) {
                        isRunning = state.isRunning || false;
                        currentLapStartTime = state.currentLapStartTime || 0;
                        currentLapElapsedTime = state.currentLapElapsedTime || 0;
                        laps = state.laps || [];
                        
                        if (isRunning) {
                            const timeSincePause = now - currentLapStartTime;
                            currentLapElapsedTime += timeSincePause;
                            currentLapStartTime = now;
                            
                            timerInterval = setInterval(updateTimerDisplay, 10);
                            startPauseBtn.innerHTML = '<i class="fas fa-pause"></i> Пауза';
                            lapBtn.disabled = false;
                            resetBtn.disabled = true;
                            
                            await requestWakeLock();
                        } else {
                            startPauseBtn.innerHTML = '<i class="fas fa-play"></i> Старт';
                            lapBtn.disabled = true;
                            resetBtn.disabled = laps.length > 0;
                        }
                        
                        updateTimerDisplay();
                        renderLaps();
                        updateStats();
                    } else {
                        resetTimer();
                    }
                }
            } catch (e) {
                console.error('Ошибка загрузки состояния таймера:', e);
            }
        }
// Автоматически восстанавливать Wake Lock при возвращении на страницу
document.addEventListener('visibilitychange', async () => {
    if (document.visibilityState === 'visible' && isRunning && wakeLock === null) {
        console.log('Страница снова видима, восстанавливаем Wake Lock');
        await requestWakeLock();
    }
});
        
        // ==================== ОСНОВНЫЕ ФУНКЦИИ ====================
        
        // Уведомления
        function showNotification(message, isSuccess = true) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.style.backgroundColor = isSuccess ? 'rgba(var(--color-success-rgb, 72, 187, 120), 0.9)' : 'rgba(var(--color-danger-rgb, 220, 53, 69), 0.9)';
            notif.style.display = 'block';
            setTimeout(() => { notif.style.display = 'none'; }, 4000);
        }
        
        // Обновление шапки
        function updateHeader(activeTab) {
            const titles = {
                'workoutSection': { title: '🏋️ Мой Дневник Тренировок', subtitle: 'Сила в дисциплине. Прогресс в деталях.' },
                'exercisesSection': { title: '📝 База упражнений', subtitle: 'Создавайте и редактируйте список упражнений.' },
                'profileSection': { title: '📊 Профиль и Статистика', subtitle: 'Введите ваши данные и отслеживайте прогресс.' },
                'timerSection': { title: '⏱️ Таймер тренировок', subtitle: 'Секундомер с кругами для интервальных тренировок.' }
            };
            const config = titles[activeTab] || titles['workoutSection'];
            document.getElementById('pageTitle').textContent = config.title;
            
            const subtitle = document.getElementById('pageSubtitle');
            subtitle.textContent = config.subtitle;
            
            if (activeTab === 'workoutSection') {
                subtitle.classList.add('diary-subtitle');
            } else {
                subtitle.classList.remove('diary-subtitle');
            }
        }
        
        // Текущая дата
        function getCurrentDateFormatted() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            return `${day}.${month}.${year}`;
        }
        
        // ==================== РАБОТА С ТРЕНИРОВКАМИ ====================
        
        // Загрузка тренировок
        function loadWorkoutLog() {
            try {
                const saved = localStorage.getItem(STORAGE_KEYS.WORKOUTS);
                return saved ? JSON.parse(saved) : [];
            } catch (error) {
                console.error('Ошибка загрузки тренировок:', error);
                return [];
            }
        }
        
        // Сохранение тренировок
        function saveWorkoutLog(workouts) {
            try {
                localStorage.setItem(STORAGE_KEYS.WORKOUTS, JSON.stringify(workouts));
            } catch (error) {
                console.error('Ошибка сохранения тренировок:', error);
                showNotification('Ошибка сохранения', false);
            }
        }
        
        // Генерация ID
        function generateWorkoutId() {
            return 'w_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // День недели
        function getDayOfWeek(dateStr) {
            const days = ['ВС', 'ПН', 'ВТ', 'СР', 'ЧТ', 'ПТ', 'СБ'];
            const parts = dateStr.split('.');
            if (parts.length !== 3) return '';
            const date = new Date(parts[2], parts[1] - 1, parts[0]);
            return days[date.getDay()];
        }
        
        // Форматирование веса/подходов
        function formatWeightSets(weightSets) {
            if (!weightSets || weightSets.length === 0) return '';
            return weightSets.map(set => {
                const parts = [];
                if (set.weight) parts.push(set.weight);
                if (set.sets && set.reps) parts.push(`${set.sets}x${set.reps} раз`);
                return parts.join(' ');
            }).join('\n');
        }
        
        // Отображение списка тренировок
        function renderWorkoutList() {
            const container = document.getElementById('workoutListContainer');
            const emptyState = document.getElementById('workoutEmptyState');
            const workouts = loadWorkoutLog();
            
            const existingCards = container.querySelectorAll('.workout-card');
            existingCards.forEach(card => card.remove());
            
            if (workouts.length === 0) {
                if (emptyState && !container.contains(emptyState)) {
                    container.appendChild(emptyState);
                }
                if (emptyState) emptyState.style.display = 'block';
                return;
            }
            
            if (emptyState) emptyState.style.display = 'none';
            
            workouts.sort((a, b) => {
                const dateA = new Date(a.date.split('.').reverse().join('-'));
                const dateB = new Date(b.date.split('.').reverse().join('-'));
                return dateB - dateA;
            });
            
            workouts.forEach(workout => {
                const card = createWorkoutCard(workout);
                container.appendChild(card);
            });
        }
        
        // Создание карточки тренировки
        function createWorkoutCard(workout) {
            const card = document.createElement('article');
            card.className = 'workout-card';
            card.dataset.type = workout.type;
            card.dataset.id = workout.id;
            
            const typeConfig = {
                strength: { name: 'Силовая в зале', class: 'type-strength' },
                circuit: { name: 'Круговая', class: 'type-circuit' },
                home: { name: 'Домашняя', class: 'type-home' },
                other: { name: workout.type, class: 'type-other' }
            };

            let typeKey = workout.type;
            if (!['strength', 'circuit', 'home'].includes(workout.type)) {
                typeKey = 'other';
            }

            const typeInfo = typeConfig[typeKey] || { name: workout.type, class: 'type-other' };

            if (typeKey === 'other') {
                typeInfo.name = workout.type;
                card.dataset.type = 'other';
            }

            const dayOfWeek = getDayOfWeek(workout.date);
            
            card.innerHTML = `
                <div class="workout-date">
                    <div class="date-text">
                        ${workout.date} <span style="color:var(--text-muted);">(${dayOfWeek})</span>
                        <button class="workout-copy-btn" title="Копировать тренировку"><i class="far fa-copy"></i></button>
                    </div>
                    <div class="workout-type ${typeInfo.class}">${typeInfo.name}</div>
                </div>
                <div class="workout-actions">
                    <button class="workout-edit-btn" title="Редактировать запись"><i class="fas fa-pencil-alt"></i></button>
                    <button class="workout-delete-btn" title="Удалить запись"><i class="fas fa-trash-alt"></i></button>
                </div>
                <div class="workout-body">
                    <div class="exercises-block">
                        ${workout.exercises.map((ex, i) => `
                            <div class="exercise-item">
                                <div class="exercise-name-row">
                                    <div class="exercise-main-name"><span class="exercise-number">${i+1}.</span> ${ex.name}</div>
                                    ${ex.spec ? `<div class="exercise-spec">${ex.spec}</div>` : ''}
                                </div>
                                ${ex.weightSets && ex.weightSets.length > 0 ? `
                                    <div class="weight-details">${formatWeightSets(ex.weightSets)}</div>
                                ` : ''}
                                ${ex.note ? `<div class="exercise-note">${ex.note}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                    ${workout.extraActivity ? `
                        <div class="extra-activity">
                            <strong><i class="fas fa-swimming-pool"></i> Доп. активность:</strong> ${workout.extraActivity}
                        </div>
                    ` : ''}
                    ${workout.weight ? `
                        <div class="metrics">
                            <div class="metric"><div class="metric-value">${workout.weight}</div><div class="metric-label">Вес (кг)</div></div>
                            <div class="metric"><div class="metric-value">${workout.bmi || '-'}</div><div class="metric-label">Индекс BMI</div></div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            card.querySelector('.workout-copy-btn').addEventListener('click', () => copyWorkout(workout.id));
            card.querySelector('.workout-edit-btn').addEventListener('click', () => editWorkout(workout.id));
            card.querySelector('.workout-delete-btn').addEventListener('click', () => deleteWorkout(workout.id));
            
            return card;
        }
        
        // Копирование тренировки
        function copyWorkout(workoutId) {
            const workouts = loadWorkoutLog();
            const workout = workouts.find(w => w.id === workoutId);
            if (!workout) {
                showNotification('Тренировка не найдена', false);
                return;
            }
            
            const copiedWorkout = JSON.parse(JSON.stringify(workout));
            copiedWorkout.id = generateWorkoutId();
            copiedWorkout.date = getCurrentDateFormatted();
            copiedWorkout.created = Date.now();
            
            openEditWorkoutForm(copiedWorkout, true);
            showNotification('Тренировка скопирована. Можно изменить данные.');
        }
        
        // Редактирование тренировки
        function editWorkout(workoutId) {
            const workouts = loadWorkoutLog();
            const workout = workouts.find(w => w.id === workoutId);
            if (!workout) {
                showNotification('Тренировка не найдена', false);
                return;
            }
            
            openEditWorkoutForm(workout, false);
            showNotification('Редактирование тренировки');
        }
        
        // Удаление тренировки
        function deleteWorkout(workoutId) {
            if (!confirm('Удалить эту тренировку?')) return;
            
            const workouts = loadWorkoutLog();
            const filtered = workouts.filter(w => w.id !== workoutId);
            
            if (filtered.length === workouts.length) {
                showNotification('Тренировка не найдена', false);
                return;
            }
            
            saveWorkoutLog(filtered);
            renderWorkoutList();
            updateWeightChart();
            showNotification('Тренировка удалена');
        }
        
        // ==================== ФОРМА ТРЕНИРОВКИ ====================
        
        // Открытие новой формы
        function openNewWorkoutForm() {
            resetForm();
            document.getElementById('formTitle').textContent = 'Новая тренировка';
            document.getElementById('submitButtonText').textContent = 'Сохранить тренировку';
            document.getElementById('workoutId').value = '';
            document.getElementById('isEditMode').value = 'false';
            document.getElementById('workoutDate').value = getCurrentDateFormatted();
            addNewExerciseRow();
            showForm();
        }
        
        // Открытие формы для редактирования/копирования
        function openEditWorkoutForm(workout, isCopy) {
            resetForm();
            
            if (isCopy) {
                document.getElementById('formTitle').textContent = 'Копирование тренировки';
                document.getElementById('submitButtonText').textContent = 'Сохранить копию';
            } else {
                document.getElementById('formTitle').textContent = 'Редактирование тренировки';
                document.getElementById('submitButtonText').textContent = 'Сохранить изменения';
            }
            
            document.getElementById('workoutId').value = workout.id;
            document.getElementById('isEditMode').value = isCopy ? 'false' : 'true';
            
            document.getElementById('workoutDate').value = workout.date;
            
            let workoutType = workout.type;
            let workoutTypeOther = '';
            if (!['strength', 'circuit', 'home'].includes(workoutType)) {
                workoutType = 'other';
                workoutTypeOther = workout.type;
            }
            document.getElementById('workoutType').value = workoutType;
            if (workoutType === 'other') {
                document.getElementById('workoutTypeOther').value = workoutTypeOther;
                document.getElementById('workoutTypeOther').style.display = 'block';
            }
            
            if (workout.exercises && workout.exercises.length > 0) {
                addNewExerciseRow();
                
                for (let i = 1; i < workout.exercises.length; i++) {
                    addNewExerciseRow();
                }
                
                document.querySelectorAll('#exercisesTableBody tr').forEach((row, index) => {
                    if (workout.exercises[index]) {
                        fillExerciseRow(row, workout.exercises[index]);
                    }
                });
            } else {
                addNewExerciseRow();
            }
            
            if (workout.extraActivity === 'Бассейн (тренировка)' || workout.extraActivity === 'Бассейн (свободное плавание)') {
                document.getElementById('extraActivityType').value = workout.extraActivity;
            } else if (workout.extraActivity) {
                document.getElementById('extraActivityType').value = 'other';
                document.getElementById('extraActivityOther').value = workout.extraActivity;
                document.getElementById('extraActivityOther').style.display = 'block';
            }
            
            if (workout.weight) {
                document.getElementById('workoutWeight').value = workout.weight;
                updateBmiDisplay();
            }
            
            showForm();
        }
        
        // Заполнение строки упражнения
        function fillExerciseRow(row, exercise) {
            const select = row.querySelector('.exercise-name-select');
            const otherInput = row.querySelector('.exercise-name-other');
            const exercises = loadExercises();
            
            const exerciseInBase = exercises.find(ex => ex === exercise.name);
            if (exerciseInBase) {
                select.value = exercise.name;
                otherInput.style.display = 'none';
            } else {
                select.value = '_other_';
                otherInput.style.display = 'block';
                otherInput.value = exercise.name;
            }
            
            const specInput = row.querySelector('.exercise-spec-input');
            if (specInput) {
                specInput.value = exercise.spec || '';
                if (specInput.tagName === 'TEXTAREA') {
                    setTimeout(() => {
                        specInput.style.height = 'auto';
                        specInput.style.height = (specInput.scrollHeight) + 'px';
                    }, 10);
                }
            }
            
            const noteInput = row.querySelector('.exercise-note-input');
            if (noteInput) {
                noteInput.value = exercise.note || '';
                setTimeout(() => {
                    noteInput.style.height = 'auto';
                    noteInput.style.height = (noteInput.scrollHeight) + 'px';
                }, 10);
            }
            
            const container = row.querySelector('.weight-sets-container');
            if (container) {
                container.innerHTML = '';
                
                if (exercise.weightSets && exercise.weightSets.length > 0) {
                    exercise.weightSets.forEach((set, setIndex) => {
                        const setRow = document.createElement('div');
                        setRow.className = 'weight-set-row';
                        setRow.dataset.setIndex = setIndex;
                        
                        const removeButtonHtml = setIndex === 0 ? '' : 
                            `<button type="button" class="btn-remove-weight-set" onclick="window.removeWeightSet('${row.id}', ${setIndex})" title="Удалить подход">
                                <i class="fas fa-trash"></i>
                            </button>`;
                        
                        setRow.innerHTML = `
                            <input type="text" class="weight-set-input" placeholder="Вес" value="${set.weight || ''}">
                            <input type="number" class="sets-input" placeholder="Подходы" value="${set.sets || ''}" min="1" max="20">
                            <input type="number" class="reps-input" placeholder="Раз" value="${set.reps || ''}" min="1" max="100">
                            <div class="weight-set-buttons">
                                ${removeButtonHtml}
                                <button type="button" class="btn-add-weight-set" onclick="window.addWeightSet('${row.id}')" title="Добавить ещё подход">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        `;
                        container.appendChild(setRow);
                    });
                } else {
                    const setRow = document.createElement('div');
                    setRow.className = 'weight-set-row';
                    setRow.dataset.setIndex = 0;
                    setRow.innerHTML = `
                        <input type="text" class="weight-set-input" placeholder="Вес">
                        <input type="number" class="sets-input" placeholder="Подходы" min="1" max="20">
                        <input type="number" class="reps-input" placeholder="Раз" min="1" max="100">
                        <div class="weight-set-buttons">
                            <button type="button" class="btn-add-weight-set" onclick="window.addWeightSet('${row.id}')" title="Добавить ещё подход">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(setRow);
                }
                
                setTimeout(() => updateWeightSetIndexes(row.id), 50);
            }
        }
        
        // Сброс формы
        function resetForm() {
            document.getElementById('newWorkoutForm').reset();
            document.getElementById('exercisesTableBody').innerHTML = '';
            exerciseRowCounter = 0;
            document.getElementById('workoutTypeOther').style.display = 'none';
            document.getElementById('extraActivityOther').style.display = 'none';
            document.getElementById('bmiValue').textContent = '-';
        }
        
        // Показать форму
        function showForm() {
            document.getElementById('newWorkoutFormOverlay').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        // Закрыть форму
        function closeForm() {
            document.getElementById('newWorkoutFormOverlay').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        // Добавить строку упражнения
        function addNewExerciseRow() {
            const tbody = document.getElementById('exercisesTableBody');
            const exercises = loadExercises();
            const rowId = `exerciseRow_${exerciseRowCounter++}`;
            
            const row = document.createElement('tr');
            row.id = rowId;
            row.dataset.exerciseIndex = tbody.children.length;
            
            let optionsHtml = '<option value="" disabled selected>Выберите...</option>';
            exercises.forEach(ex => {
                optionsHtml += `<option value="${ex}">${ex}</option>`;
            });
            optionsHtml += '<option value="_other_">Другое (ввести)</option>';
            
            row.innerHTML = `
                <td data-label="Упражнение">
                    <select class="exercise-name-select" style="width: 100%;" onchange="window.handleExerciseSelectChange(this, '${rowId}')">
                        ${optionsHtml}
                    </select>
                    <input type="text" class="exercise-name-other" placeholder="Введите название" style="margin-top: 8px; display: none;">
                </td>
                <td data-label="Спецификация">
                    <textarea class="exercise-spec-input" placeholder="Например: широкий хват" rows="1"></textarea>
                </td>
                <td data-label="Вес/Подходы">
                    <div class="weight-sets-container">
                        <div class="weight-set-row" data-set-index="0">
                            <input type="text" class="weight-set-input" placeholder="Вес">
                            <input type="number" class="sets-input" placeholder="Подходы" min="1" max="20">
                            <input type="number" class="reps-input" placeholder="Раз" min="1" max="100">
                            <div class="weight-set-buttons">
                                <button type="button" class="btn-add-weight-set" onclick="window.addWeightSet('${rowId}')" title="Добавить ещё подход">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </td>
                <td data-label="Примечание">
                    <textarea class="exercise-note-input" placeholder="Заметка..." rows="1"></textarea>
                </td>
                <td class="exercise-row-actions" data-label="Действия">
                    <div class="order-buttons">
    <button type="button" class="btn-move-up" onclick="moveExerciseUp('${rowId}')" title="Переместить вверх">
        <i class="fas fa-arrow-up"></i>
    </button>
    <button type="button" class="btn-remove-row" onclick="removeExerciseRow('${rowId}')" title="Удалить упражнение">
        <i class="fas fa-trash-alt"></i>
    </button>
    <button type="button" class="btn-move-down" onclick="moveExerciseDown('${rowId}')" title="Переместить вниз">
        <i class="fas fa-arrow-down"></i>
    </button>
</div>
                </td>
            `;
            
            tbody.appendChild(row);
            
            const textarea = row.querySelector('.exercise-note-input');
            if (textarea) {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            }
            
            const specTextarea = row.querySelector('.exercise-spec-input');
            if (specTextarea) {
                specTextarea.addEventListener('input', autoResizeTextarea);
                setTimeout(() => autoResizeTextarea.call(specTextarea), 10);
            }
            
            return rowId;
        }
        
        // Общая функция авто-высоты для textarea
        function autoResizeTextarea() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        }
        
        // Обработка выбора упражнения
        function handleExerciseSelectChange(select, rowId) {
            const row = document.getElementById(rowId);
            if (!row) return;
            
            const otherInput = row.querySelector('.exercise-name-other');
            if (select.value === '_other_') {
                otherInput.style.display = 'block';
                otherInput.required = true;
            } else {
                otherInput.style.display = 'none';
                otherInput.required = false;
            }
        }
        
        // Добавление набора веса/подходов
        function addWeightSet(rowId) {
            const row = document.getElementById(rowId);
            if (!row) return;
            
            const container = row.querySelector('.weight-sets-container');
            if (!container) return;
            
            const existingSets = container.querySelectorAll('.weight-set-row');
            const newIndex = existingSets.length;
            
            const setRow = document.createElement('div');
            setRow.className = 'weight-set-row';
            setRow.dataset.setIndex = newIndex;
            
            const removeButtonHtml = newIndex === 0 ? '' : 
                `<button type="button" class="btn-remove-weight-set" onclick="window.removeWeightSet('${rowId}', ${newIndex})" title="Удалить подход">
                    <i class="fas fa-trash-alt"></i>
                </button>`;
            
            setRow.innerHTML = `
                <input type="text" class="weight-set-input" placeholder="Вес">
                <input type="number" class="sets-input" placeholder="Подходы" min="1" max="20">
                <input type="number" class="reps-input" placeholder="Раз" min="1" max="100">
                <div class="weight-set-buttons">
                    ${removeButtonHtml}
                    <button type="button" class="btn-add-weight-set" onclick="window.addWeightSet('${rowId}')" title="Добавить ещё подход">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(setRow);
            
            updateWeightSetIndexes(rowId);
        }
        
        function removeWeightSet(rowId, setIndex) {
            const row = document.getElementById(rowId);
            if (!row) return;
            
            const container = row.querySelector('.weight-sets-container');
            if (!container) return;
            
            const setToRemove = container.querySelector(`.weight-set-row[data-set-index="${setIndex}"]`);
            if (!setToRemove) return;
            
            const firstSet = container.querySelector('.weight-set-row[data-set-index="0"]');
            if (setToRemove === firstSet) {
                showNotification('Первый подход нельзя удалить', false);
                return;
            }
            
            setToRemove.remove();
            
            updateWeightSetIndexes(rowId);
            
            showNotification('Подход удалён');
        }
        
        function updateWeightSetIndexes(rowId) {
            const row = document.getElementById(rowId);
            if (!row) return;
            
            const container = row.querySelector('.weight-sets-container');
            if (!container) return;
            
            const allSets = container.querySelectorAll('.weight-set-row');
            
            allSets.forEach((set, index) => {
                set.dataset.setIndex = index;
                
                const buttonsContainer = set.querySelector('.weight-set-buttons');
                if (buttonsContainer) {
                    const removeBtn = buttonsContainer.querySelector('.btn-remove-weight-set');
                    const addBtn = buttonsContainer.querySelector('.btn-add-weight-set');
                    
                    if (removeBtn) {
                        removeBtn.setAttribute('onclick', `window.removeWeightSet('${rowId}', ${index})`);
                        removeBtn.style.display = index === 0 ? 'none' : 'flex';
                    }
                    if (addBtn) {
                        addBtn.setAttribute('onclick', `window.addWeightSet('${rowId}')`);
                    }
                }
            });
        }
        
        // Удаление строки упражнения
        function removeExerciseRow(rowId) {
            const row = document.getElementById(rowId);
            if (!row) return;
            
            if (document.querySelectorAll('#exercisesTableBody tr').length > 1) {
                row.remove();
            } else {
                const inputs = row.querySelectorAll('input, select');
                inputs.forEach(input => {
                    if (input.type !== 'button') {
                        input.value = '';
                    }
                });
            }
        }
        
        // Функции для перемещения упражнений
        function moveExerciseUp(rowId) {
            const row = document.getElementById(rowId);
            if (!row) return;
            
            const tbody = document.getElementById('exercisesTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const currentIndex = rows.indexOf(row);
            
            if (currentIndex <= 0) {
                showNotification('Упражнение уже находится наверху', false);
                return;
            }
            
            const prevRow = rows[currentIndex - 1];
            tbody.insertBefore(row, prevRow);
            
            updateExerciseIndexes();
            showNotification('Упражнение перемещено вверх');
        }
        
        function moveExerciseDown(rowId) {
            const row = document.getElementById(rowId);
            if (!row) return;
            
            const tbody = document.getElementById('exercisesTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const currentIndex = rows.indexOf(row);
            
            if (currentIndex >= rows.length - 1) {
                showNotification('Упражнение уже находится внизу', false);
                return;
            }
            
            const nextRow = rows[currentIndex + 1];
            if (nextRow.nextSibling) {
                tbody.insertBefore(row, nextRow.nextSibling);
            } else {
                tbody.appendChild(row);
            }
            
            updateExerciseIndexes();
            showNotification('Упражнение перемещено вниз');
        }
        
        function updateExerciseIndexes() {
            const tbody = document.getElementById('exercisesTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach((row, index) => {
                row.dataset.exerciseIndex = index;
                
                const numberSpans = row.querySelectorAll('.exercise-number');
                numberSpans.forEach(span => {
                    span.textContent = `${index + 1}.`;
                });
                
                const moveUpBtn = row.querySelector('.btn-move-up');
                const moveDownBtn = row.querySelector('.btn-move-down');
                const removeBtn = row.querySelector('.btn-remove-row');
                
                if (moveUpBtn) {
                    moveUpBtn.setAttribute('onclick', `window.moveExerciseUp('${row.id}')`);
                    moveUpBtn.disabled = (index === 0);
                }
                if (moveDownBtn) {
                    moveDownBtn.setAttribute('onclick', `window.moveExerciseDown('${row.id}')`);
                    moveDownBtn.disabled = (index === rows.length - 1);
                }
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', `window.removeExerciseRow('${row.id}')`);
                }
            });
        }
        
        // Обновление BMI
        function updateBmiDisplay() {
            const weight = parseFloat(document.getElementById('workoutWeight').value);
            const profile = loadProfile();
            
            if (!weight || !profile || !profile.height) {
                document.getElementById('bmiValue').textContent = '-';
                return;
            }
            
            const heightInMeters = profile.height / 100;
            const bmi = weight / (heightInMeters * heightInMeters);
            document.getElementById('bmiValue').textContent = bmi.toFixed(1);
        }
        
        // Обработка отправки формы
        function handleWorkoutFormSubmit(event) {
            event.preventDefault();
            
            const workoutId = document.getElementById('workoutId').value;
            const isEditMode = document.getElementById('isEditMode').value === 'true';
            const workouts = loadWorkoutLog();
            
            const workoutDate = document.getElementById('workoutDate').value;
            let workoutType = document.getElementById('workoutType').value;
            if (workoutType === 'other') {
                workoutType = document.getElementById('workoutTypeOther').value.trim() || 'Другое';
            }
            
            const exercises = [];
            document.querySelectorAll('#exercisesTableBody tr').forEach(row => {
                const nameSelect = row.querySelector('.exercise-name-select');
                const otherInput = row.querySelector('.exercise-name-other');
                let exerciseName = '';
                
                if (nameSelect.value === '_other_') {
                    exerciseName = otherInput.value.trim();
                } else {
                    exerciseName = nameSelect.value;
                }
                
                if (!exerciseName) return;
                
                const exercise = {
                    name: exerciseName,
                    spec: row.querySelector('.exercise-spec-input').value.trim(),
                    note: row.querySelector('.exercise-note-input').value.trim(),
                    weightSets: []
                };
                
                row.querySelectorAll('.weight-set-row').forEach(setRow => {
                    const weight = setRow.querySelector('.weight-set-input').value.trim();
                    const sets = setRow.querySelector('.sets-input').value;
                    const reps = setRow.querySelector('.reps-input').value;
                    
                    if (weight || sets || reps) {
                        exercise.weightSets.push({
                            weight: weight || '',
                            sets: sets || '',
                            reps: reps || ''
                        });
                    }
                });
                
                exercises.push(exercise);
            });
            
            if (exercises.length === 0) {
                showNotification('Добавьте хотя бы одно упражнение', false);
                return;
            }
            
            let extraActivity = document.getElementById('extraActivityType').value;
            if (extraActivity === 'other') {
                extraActivity = document.getElementById('extraActivityOther').value.trim() || '';
            } else if (extraActivity === '') {
                extraActivity = null;
            }
            
            const weight = document.getElementById('workoutWeight').value ? 
                parseFloat(document.getElementById('workoutWeight').value) : null;
            const bmi = weight ? parseFloat(document.getElementById('bmiValue').textContent) : null;
            
            const workout = {
                id: isEditMode ? workoutId : generateWorkoutId(),
                date: workoutDate,
                type: workoutType,
                exercises: exercises,
                extraActivity: extraActivity,
                weight: weight,
                bmi: bmi,
                created: isEditMode ? workouts.find(w => w.id === workoutId)?.created || Date.now() : Date.now()
            };
            
            if (isEditMode) {
                const index = workouts.findIndex(w => w.id === workoutId);
                if (index !== -1) {
                    workouts[index] = workout;
                }
            } else {
                workouts.push(workout);
            }
            
            saveWorkoutLog(workouts);
            renderWorkoutList();
            updateWeightChart();
            closeForm();
            
            showNotification(isEditMode ? 'Тренировка обновлена' : 'Тренировка добавлена');
        }
        
        // ==================== БАЗА УПРАЖНЕНИЙ ====================
        
        // Загрузка упражнений
        function loadExercises() {
            try {
                const saved = localStorage.getItem(STORAGE_KEYS.EXERCISES);
                return saved ? JSON.parse(saved) : [];
            } catch (error) {
                console.error('Ошибка загрузки упражнений:', error);
                return [];
            }
        }
        
        // Сохранение упражнений
        function saveExercises(exercises) {
            try {
const sortedExercises = exercises.sort((a, b) => {
            return a.localeCompare(b, 'ru', { sensitivity: 'base' });
        });                
localStorage.setItem(STORAGE_KEYS.EXERCISES, JSON.stringify(exercises));
            } catch (error) {
                console.error('Ошибка сохранения упражнений:', error);
                showNotification('Ошибка сохранения упражнений', false);
            }
        }
        
        // Отображение списка упражнений
        function renderExercisesList() {
            const list = document.getElementById('exercisesList');
            const emptyMsg = document.getElementById('emptyExercisesList');
            const exercises = loadExercises();
            
            const existingItems = list.querySelectorAll('.exercise-list-item');
            existingItems.forEach(item => item.remove());
            
            if (exercises.length === 0) {
                if (emptyMsg) emptyMsg.style.display = 'block';
                return;
            }
            
            if (emptyMsg) emptyMsg.style.display = 'none';
            
            exercises.forEach((exercise, index) => {
                const li = document.createElement('li');
                li.className = 'exercise-list-item';
                li.dataset.index = index;
                li.innerHTML = `
                    <span class="exercise-list-name">${exercise}</span>
                    <input type="text" class="exercise-list-edit-input" value="${exercise}">
                    <div class="exercise-list-actions">
                        <button class="btn-edit" title="Редактировать"><i class="fas fa-pencil-alt"></i></button>
                        <button class="btn-save-edit" title="Сохранить"><i class="fas fa-check"></i></button>
                        <button class="btn-cancel-edit" title="Отмена"><i class="fas fa-times"></i></button>
                        <button class="btn-delete" title="Удалить"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                list.appendChild(li);
                
                const editBtn = li.querySelector('.btn-edit');
                const saveBtn = li.querySelector('.btn-save-edit');
                const cancelBtn = li.querySelector('.btn-cancel-edit');
                const deleteBtn = li.querySelector('.btn-delete');
                const nameSpan = li.querySelector('.exercise-list-name');
                const editInput = li.querySelector('.exercise-list-edit-input');
                
                editBtn.addEventListener('click', function() {
                    nameSpan.classList.add('editing');
                    editInput.classList.add('editing');
                    editBtn.style.display = 'none';
                    saveBtn.style.display = 'inline-block';
                    cancelBtn.style.display = 'inline-block';
                    editInput.focus();
                    editInput.select();
                });
                
                saveBtn.addEventListener('click', function() {
                    const newName = editInput.value.trim();
                    if (!newName) {
                        showNotification('Название не может быть пустым', false);
                        return;
                    }
                    
                    exercises[index] = newName;
                    saveExercises(exercises);
                    renderExercisesList();
                    showNotification('Упражнение обновлено');
                });
                
                cancelBtn.addEventListener('click', function() {
                    nameSpan.classList.remove('editing');
                    editInput.classList.remove('editing');
                    editBtn.style.display = 'inline-block';
                    saveBtn.style.display = 'none';
                    cancelBtn.style.display = 'none';
                    editInput.value = exercises[index];
                });
                
                deleteBtn.addEventListener('click', function() {
                    if (!confirm('Удалить это упражнение?')) return;
                    
                    exercises.splice(index, 1);
                    saveExercises(exercises);
                    renderExercisesList();
                    showNotification('Упражнение удалено');
                });
            });
        }
        
        // Добавление нового упражнения
        function addNewExercise(event) {
            event.preventDefault();
            const input = document.getElementById('newExerciseInput');
            const name = input.value.trim();
            
            if (!name) {
                showNotification('Введите название упражнения', false);
                return;
            }
            
            const exercises = loadExercises();
            if (exercises.includes(name)) {
                showNotification('Такое упражнение уже есть в базе', false);
                return;
            }
            
            exercises.push(name);
            saveExercises(exercises);
            renderExercisesList();
            input.value = '';
            showNotification('Упражнение добавлено');
        }
        
        // ==================== ПРОФИЛЯ ====================
        
        // Загрузка профиля
       function loadProfile() {
    try {
        const saved = localStorage.getItem(STORAGE_KEYS.PROFILE);
        if (!saved) return null;
        
        const profile = JSON.parse(saved);
        
        const nameInput = document.getElementById('profileUserName');
        const heightInput = document.getElementById('profileUserHeight');
        
        if (nameInput && profile.name) nameInput.value = profile.name;
        if (heightInput && profile.height) heightInput.value = profile.height;
        
        return profile;
    } catch (error) {
        console.error('Ошибка загрузки профиля:', error);
        return null;
    }
}
        
        // Сохранение профиля
        function saveProfile(event) {
    event.preventDefault();
    
    const name = document.getElementById('profileUserName').value.trim();
    const height = document.getElementById('profileUserHeight').value;
    
    if (!name || !height) {
        showNotification('Заполните все обязательные поля', false);
        return;
    }
    
    const profile = {
        name: name,
        height: parseFloat(height)
    };
    
    try {
        localStorage.setItem(STORAGE_KEYS.PROFILE, JSON.stringify(profile));
        showNotification('Профиль сохранён');
    } catch (error) {
        console.error('Ошибка сохранения профиля:', error);
        showNotification('Ошибка сохранения профиля', false);
    }
}
        
        // ==================== ГРАФИК ВЕСА ====================
        
        const PERIOD_MS = {
            '30days': 30 * 24 * 60 * 60 * 1000,
            '3month': 90 * 24 * 60 * 60 * 1000,
            'year': 365 * 24 * 60 * 60 * 1000,
            'all': null
        };
        
        let currentChartPeriod = 'all';
        
        function loadChartPeriod() {
            try {
                const saved = localStorage.getItem('workoutDiary_chartPeriod');
                if (saved && PERIOD_MS.hasOwnProperty(saved)) {
                    return saved;
                }
            } catch (e) {
                console.error('Ошибка загрузки периода:', e);
            }
            return 'all';
        }
        
        function saveChartPeriod(period) {
            try {
                localStorage.setItem('workoutDiary_chartPeriod', period);
            } catch (e) {
                console.error('Ошибка сохранения периода:', e);
            }
        }
        
        function filterWeightDataByPeriod(weightData, period) {
            if (period === 'all' || !PERIOD_MS[period]) {
                return weightData;
            }
            
            const now = new Date();
            const periodStart = new Date(now.getTime() - PERIOD_MS[period]);
            
            return weightData.filter(item => {
                try {
                    const parts = item.date.split('.');
                    if (parts.length !== 3) return false;
                    const itemDate = new Date(parts[2], parts[1] - 1, parts[0]);
                    return itemDate >= periodStart && itemDate <= now;
                } catch (e) {
                    return false;
                }
            });
        }
        
        function findExtremes(weightData) {
            if (weightData.length === 0) {
                return { min: null, max: null };
            }
            
            let minIndex = 0;
            let maxIndex = 0;
            
            for (let i = 1; i < weightData.length; i++) {
                if (weightData[i].weight < weightData[minIndex].weight) {
                    minIndex = i;
                }
                if (weightData[i].weight > weightData[maxIndex].weight) {
                    maxIndex = i;
                }
            }
            
            return {
                min: {
                    index: minIndex,
                    date: weightData[minIndex].date,
                    weight: weightData[minIndex].weight
                },
                max: {
                    index: maxIndex,
                    date: weightData[maxIndex].date,
                    weight: weightData[maxIndex].weight
                }
            };
        }
        
        function formatDateLabel(dateStr, index, allLabels) {
            const parts = dateStr.split('.');
            if (parts.length !== 3) return dateStr;
            
            if (allLabels.length > 30) {
                return `${parts[0]}.${parts[1]}`;
            }
            if (allLabels.length > 14) {
                if (index % 7 === 0 || index === allLabels.length - 1) {
                    return `${parts[0]}.${parts[1]}.${parts[2].slice(2)}`;
                }
                return `${parts[0]}.${parts[1]}`;
            }
            return dateStr;
        }
        
        function updateExtremesInfo(extremes) {
            const infoDiv = document.getElementById('extremesInfo');
            const minSpan = document.getElementById('extremeMinValue');
            const maxSpan = document.getElementById('extremeMaxValue');
            
            if (!extremes.min || !extremes.max) {
                infoDiv.style.display = 'none';
                return;
            }
            
            minSpan.textContent = extremes.min.weight.toFixed(1);
            maxSpan.textContent = extremes.max.weight.toFixed(1);
            infoDiv.style.display = 'flex';
        }
        
        // Основная функция обновления графика - ИСПРАВЛЕНА
        function updateWeightChart() {
            const workouts = loadWorkoutLog();
            const allWeightData = [];
            
            workouts.forEach(workout => {
                if (workout.date && workout.weight && !isNaN(parseFloat(workout.weight))) {
                    const weight = parseFloat(workout.weight);
                    if (weight > 30 && weight < 200) {
                        allWeightData.push({
                            date: workout.date,
                            weight: weight
                        });
                    }
                }
            });
            
            allWeightData.sort((a, b) => {
                const dateA = new Date(a.date.split('.').reverse().join('-'));
                const dateB = new Date(b.date.split('.').reverse().join('-'));
                return dateA - dateB;
            });
            
            const placeholder = document.getElementById('chartPlaceholder');
            const canvas = document.getElementById('weightChartCanvas');
            const period = currentChartPeriod;
            
            const filteredData = filterWeightDataByPeriod(allWeightData, period);
            
            if (filteredData.length < 2) {
                placeholder.style.display = 'block';
                canvas.style.display = 'none';
                if (weightChart) {
                    weightChart.destroy();
                    weightChart = null;
                }
                document.getElementById('extremesInfo').style.display = 'none';
                return;
            }
            
            placeholder.style.display = 'none';
            canvas.style.display = 'block';
            
            const labels = filteredData.map(item => item.date);
            const weights = filteredData.map(item => item.weight);
            
            const extremes = findExtremes(filteredData);
            updateExtremesInfo(extremes);
            
            const minData = new Array(filteredData.length).fill(null);
            const maxData = new Array(filteredData.length).fill(null);
            
            if (extremes.min) {
                minData[extremes.min.index] = extremes.min.weight;
            }
            if (extremes.max) {
                maxData[extremes.max.index] = extremes.max.weight;
            }
            
            const ctx = canvas.getContext('2d');
            
            if (weightChart) {
                weightChart.destroy();
            }
            
            // ВАЖНО: Используем фиксированные цвета для графика, которые работают во всех темах
            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Вес (кг)',
                            data: weights,
                            borderColor: '#ffd166', // Фиксированный цвет для линии
                            backgroundColor: 'rgba(255, 209, 102, 0.1)', // Фиксированный цвет для заливки
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointHoverRadius: 7
                        },
                        {
                            label: 'Минимум',
                            data: minData,
                            type: 'scatter',
                            pointBackgroundColor: '#48bb78', // Фиксированный зеленый
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 8,
                            pointHoverRadius: 12,
                            showLine: false
                        },
                        {
                            label: 'Максимум',
                            data: maxData,
                            type: 'scatter',
                            pointBackgroundColor: '#ff6b6b', // Фиксированный красный
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 8,
                            pointHoverRadius: 12,
                            showLine: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    
                                    if (label === 'Минимум') {
                                        return `Минимальный вес: ${value.toFixed(1)} кг`;
                                    }
                                    if (label === 'Максимум') {
                                        return `Максимальный вес: ${value.toFixed(1)} кг`;
                                    }
                                    return `Вес: ${value.toFixed(1)} кг`;
                                },
                                afterLabel: function(context) {
                                    if (context.datasetIndex === 0) {
                                        const dataIndex = context.dataIndex;
                                        if (extremes.min && extremes.min.index === dataIndex) {
                                            return '(Минимум за период)';
                                        }
                                        if (extremes.max && extremes.max.index === dataIndex) {
                                            return '(Максимум за период)';
                                        }
                                    }
                                    return null;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#aaa',
                                callback: function(value) {
                                    return value + ' кг';
                                }
                            },
                            suggestedMin: Math.min(...weights) - 1,
                            suggestedMax: Math.max(...weights) + 1
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#aaa',
                                maxRotation: 45,
                                minRotation: 0,
                                callback: function(value, index) {
                                    return formatDateLabel(this.getLabelForValue(value), index, labels);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Инициализация кнопок периодов
        function initPeriodFilters() {
            const buttons = document.querySelectorAll('.period-btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const period = this.dataset.period;
                    
                    buttons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    currentChartPeriod = period;
                    saveChartPeriod(period);
                    updateWeightChart();
                    
                    showNotification(`Период графика: ${this.textContent}`);
                });
            });
        }
        
        // ==================== ЭКСПОРТ/ИМПОРТ ====================
        
        // Экспорт всех данных в JSON - ИСПРАВЛЕНА
       // ==================== ЭКСПОРТ/ИМПОРТ ====================

// Экспорт всех данных в JSON
async function exportAllData() {
    try {
        const allData = {
            version: DATA_FORMAT_VERSION,
            exportedAt: new Date().toISOString(),
            dataFormat: 'workoutDiary_v1',
            workouts: loadWorkoutLog(),
            exercises: loadExercises(),
            profile: loadProfile(),
            timerState: JSON.parse(localStorage.getItem(STORAGE_KEYS.TIMER_STATE) || '{}'),
            chartPeriod: currentChartPeriod,
            theme: localStorage.getItem(STORAGE_KEYS.THEME) || 'dark'
        };
        
        const jsonData = JSON.stringify(allData, null, 2);
        const fileName = `workout_diary_${new Date().toISOString().slice(0, 10)}.json`;
        
        const blob = new Blob([jsonData], { type: 'application/json;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        setTimeout(() => URL.revokeObjectURL(url), 100);
        
        showNotification('✅ Данные экспортированы');
        
    } catch (error) {
        console.error('Ошибка экспорта:', error);
        showNotification('❌ Ошибка при экспорте', false);
    }
}

// Импорт данных из JSON
function importDataFromFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = function(event) {
            try {
                const jsonData = event.target.result;
                const importedData = JSON.parse(jsonData);
                
                if (!importedData.dataFormat || !importedData.dataFormat.includes('workoutDiary')) {
                    reject(new Error('Неверный формат файла. Файл не является резервной копией Дневника Тренировок.'));
                    return;
                }
                
                resolve(importedData);
                
            } catch (error) {
                reject(new Error('Ошибка чтения JSON-файла: ' + error.message));
            }
        };
        
        reader.onerror = function() {
            reject(new Error('Ошибка чтения файла'));
        };
        
        reader.readAsText(file, 'UTF-8');
    });
}

// Выполнить импорт с выбранными опциями
function performImport(importedData, importOption) {
    try {
        const currentWorkouts = loadWorkoutLog();
        const currentExercises = loadExercises();
        const currentProfile = loadProfile();
        
        switch(importOption) {
            case 'full':
                if (importedData.workouts) {
                    saveWorkoutLog(importedData.workouts);
                }
                if (importedData.exercises) {
                    saveExercises(importedData.exercises);
                }
                if (importedData.profile) {
                    localStorage.setItem(STORAGE_KEYS.PROFILE, JSON.stringify(importedData.profile));
                }
                if (importedData.timerState) {
                    localStorage.setItem(STORAGE_KEYS.TIMER_STATE, JSON.stringify(importedData.timerState));
                }
                if (importedData.chartPeriod) {
                    localStorage.setItem('workoutDiary_chartPeriod', importedData.chartPeriod);
                    currentChartPeriod = importedData.chartPeriod;
                }
                if (importedData.theme) {
                    localStorage.setItem(STORAGE_KEYS.THEME, importedData.theme);
                    setTheme(importedData.theme);
                }
                break;
                
            case 'merge':
                if (importedData.workouts) {
                    const mergedWorkouts = [...currentWorkouts];
                    importedData.workouts.forEach(newWorkout => {
                        if (!mergedWorkouts.some(existing => existing.id === newWorkout.id)) {
                            mergedWorkouts.push(newWorkout);
                        }
                    });
                    saveWorkoutLog(mergedWorkouts);
                }
                
                if (importedData.exercises) {
                    const mergedExercises = [...currentExercises];
                    importedData.exercises.forEach(newExercise => {
                        if (!mergedExercises.some(existing => existing.toLowerCase() === newExercise.toLowerCase())) {
                            mergedExercises.push(newExercise);
                        }
                    });
                    saveExercises(mergedExercises);
                }
                break;
                
            case 'exercises':
                if (importedData.exercises) {
const sortedExercises = importedData.exercises.sort((a, b) => {
            return a.localeCompare(b, 'ru', { sensitivity: 'base' });
        });                    
saveExercises(importedData.exercises);
                }
                break;
        }
        
        renderWorkoutList();
        renderExercisesList();
        updateWeightChart();
        loadProfile();
        
        showNotification('Данные успешно импортированы!');
        
        closeImportModal();
        
    } catch (error) {
        console.error('Ошибка импорта:', error);
        showNotification('Ошибка при импорте данных: ' + error.message, false);
    }
}

// Инициализация функционала экспорта/импорта - УПРОЩЕННАЯ ВЕРСИЯ
// Показать модальное окно импорта
function showImportModal(importedData) {
    const modal = document.getElementById('importModal');
    const summaryDiv = document.getElementById('importSummary');
    const statsDiv = document.getElementById('importStats');
    
    if (!modal) return;
    
    // Показываем сводку данных
    if (importedData) {
        let statsHTML = '<ul style="list-style: none; padding-left: 0;">';
        
        if (importedData.workouts && Array.isArray(importedData.workouts)) {
            statsHTML += `<li><i class="fas fa-dumbbell"></i> Тренировок: <strong>${importedData.workouts.length}</strong></li>`;
        }
        
        if (importedData.exercises && Array.isArray(importedData.exercises)) {
            statsHTML += `<li><i class="fas fa-list-check"></i> Упражнений: <strong>${importedData.exercises.length}</strong></li>`;
        }
        
        if (importedData.profile) {
            statsHTML += `<li><i class="fas fa-user-circle"></i> Профиль: <strong>${importedData.profile.name || 'без имени'}</strong></li>`;
        }
        
        if (importedData.exportedAt) {
            const exportDate = new Date(importedData.exportedAt);
            statsHTML += `<li><i class="fas fa-calendar-alt"></i> Дата экспорта: <strong>${exportDate.toLocaleDateString('ru-RU')}</strong></li>`;
        }
        
        statsHTML += '</ul>';
        statsDiv.innerHTML = statsHTML;
        summaryDiv.style.display = 'block';
    } else {
        summaryDiv.style.display = 'none';
    }
    
    // Показываем модальное окно
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

// Закрыть модальное окно импорта
function closeImportModal() {
    const modal = document.getElementById('importModal');
    if (!modal) return;
    
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    
    // Сбрасываем данные
    document.getElementById('importSummary').style.display = 'none';
    document.getElementById('importFileInput').value = '';
    window.pendingImportData = null;
}

function initExportImport() {
    // Устанавливаем обработчики только один раз
    const exportBtn = document.getElementById('exportAllBtn');
    const importBtn = document.getElementById('importBtn');
    const reportBtn = document.getElementById('exportReportBtn');
    
    // Удаляем старые обработчики перед добавлением новых
    const newExportBtn = exportBtn.cloneNode(true);
    const newImportBtn = importBtn.cloneNode(true);
    const newReportBtn = reportBtn.cloneNode(true);
    
    exportBtn.parentNode.replaceChild(newExportBtn, exportBtn);
    importBtn.parentNode.replaceChild(newImportBtn, importBtn);
    reportBtn.parentNode.replaceChild(newReportBtn, reportBtn);
    
    // Назначаем обработчики на новые элементы
    newExportBtn.addEventListener('click', async function(e) {
        if (!navigator.onLine) {
            e.preventDefault();
            e.stopPropagation();
            showNotification('Экспорт требует интернет-соединения', false);
            return false;
        }
        await exportAllData();
    });
    
    newImportBtn.addEventListener('click', function(e) {
        if (!navigator.onLine) {
            e.preventDefault();
            e.stopPropagation();
            showNotification('Импорт требует интернет-соединения для загрузки файлов', false);
            return false;
        }
        document.getElementById('importFileInput').click();
    });
    
    newReportBtn.addEventListener('click', function(e) {
        showReportModal();
    });
    
    // Обработка выбора файла для импорта
    document.getElementById('importFileInput').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.name.toLowerCase().endsWith('.json')) {
            showNotification('Пожалуйста, выберите JSON-файл', false);
            return;
        }
        
        importDataFromFile(file)
            .then(importedData => {
                showImportModal(importedData);
                window.pendingImportData = importedData;
            })
            .catch(error => {
                showNotification(error.message, false);
                console.error('Ошибка загрузки файла:', error);
            });
    });
    
    // Закрытие модального окна импорта
    document.getElementById('closeImportModal').addEventListener('click', closeImportModal);
    document.getElementById('cancelImportBtn').addEventListener('click', closeImportModal);
    
    // Подтверждение импорта
    document.getElementById('confirmImportBtn').addEventListener('click', () => {
        const importOption = document.querySelector('input[name="importOption"]:checked').value;
        
        if (window.pendingImportData) {
            performImport(window.pendingImportData, importOption);
        } else {
            showNotification('Нет данных для импорта', false);
            closeImportModal();
        }
    });
    
    // Закрытие модального окна по клику вне его
    document.getElementById('importModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeImportModal();
        }
    });
}
        
        // ==================== ОТЧЕТЫ ====================
        
        // Функция для отображения модального окна отчета
        function showReportModal() {
            document.getElementById('reportModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            document.getElementById('reportDateTo').value = `${day}.${month}.${year}`;
        }
        
        // Функция для закрытия модального окна отчета
        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('customDatesContainer').style.display = 'none';
        }
        
        // Фильтрация тренировок по выбранному периоду
        function filterWorkoutsByPeriod(workouts, period, dateFrom, dateTo) {
            if (period === 'all') {
                return workouts;
            }
            
            const now = new Date();
            let startDate;
            
            switch(period) {
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    break;
                case 'custom':
                    if (!dateFrom || !dateTo) {
                        return workouts;
                    }
                    try {
                        const fromParts = dateFrom.split('.');
                        const toParts = dateTo.split('.');
                        startDate = new Date(fromParts[2], fromParts[1] - 1, fromParts[0]);
                        const endDate = new Date(toParts[2], toParts[1] - 1, toParts[0]);
                        
                        return workouts.filter(workout => {
                            try {
                                const parts = workout.date.split('.');
                                const workoutDate = new Date(parts[2], parts[1] - 1, parts[0]);
                                return workoutDate >= startDate && workoutDate <= endDate;
                            } catch (e) {
                                return false;
                            }
                        });
                    } catch (e) {
                        console.error('Ошибка парсинга дат:', e);
                        return workouts;
                    }
            }
            
            return workouts.filter(workout => {
                try {
                    const parts = workout.date.split('.');
                    const workoutDate = new Date(parts[2], parts[1] - 1, parts[0]);
                    return workoutDate >= startDate && workoutDate <= now;
                } catch (e) {
                    return false;
                }
            });
        }
        
        // Форматирование веса/подходов для текстового отчета
        function formatWeightSetsForReport(weightSets) {
            if (!weightSets || weightSets.length === 0) return '';
            
            return weightSets.map(set => {
                const parts = [];
                if (set.weight) parts.push(set.weight);
                if (set.sets && set.reps) parts.push(`${set.sets}x${set.reps}`);
                return parts.join(' ');
            }).join(', ');
        }
        
        // Генерация текстового отчета
        function generateTextReport(workouts, period) {
            let report = '';
            
            const workoutTypeMapping = {
                'strength': 'Силовая в зале',
                'circuit': 'Круговая',
                'home': 'Домашняя',
                'cardio': 'Кардио',
                'yoga': 'Йога',
                'stretching': 'Растяжка',
                'crossfit': 'Кроссфит',
                'other': 'Другое'
            };
            
            report += '='.repeat(60) + '\n';
            report += 'ОТЧЕТ О ТРЕНИРОВКАХ\n';
            report += '='.repeat(60) + '\n\n';
            
            const periodNames = {
                'all': 'Все тренировки',
                'week': 'За последнюю неделю',
                'month': 'За последний месяц',
                'custom': 'За выбранный период'
            };
            
            report += `Период: ${periodNames[period] || period}\n`;
            report += `Количество тренировок: ${workouts.length}\n`;
            report += `Дата формирования: ${new Date().toLocaleDateString('ru-RU')}\n`;
            report += '-'.repeat(60) + '\n\n';
            
            if (workouts.length === 0) {
                report += 'За выбранный период тренировок не найдено.\n';
                report += '='.repeat(60) + '\n';
                return report;
            }
            
            const sortedWorkouts = [...workouts].sort((a, b) => {
                const dateA = new Date(a.date.split('.').reverse().join('-'));
                const dateB = new Date(b.date.split('.').reverse().join('-'));
                return dateB - dateA;
            });
            
            let totalExercises = 0;
            let workoutsWithWeight = 0;
            let totalWeight = 0;
            
            sortedWorkouts.forEach((workout, index) => {
                report += `ТРЕНИРОВКА ${index + 1}\n`;
                report += `Дата: ${workout.date}\n`;
                const russianType = workoutTypeMapping[workout.type] || workout.type;
                report += `Тип: ${russianType}\n`;
                report += '\n';
                
                report += 'Упражнения:\n';
                workout.exercises.forEach((ex, exIndex) => {
                    totalExercises++;
                    report += `  ${exIndex + 1}. ${ex.name}`;
                    if (ex.spec) {
                        report += ` (${ex.spec})`;
                    }
                    report += '\n';
                    
                    const weightInfo = formatWeightSetsForReport(ex.weightSets);
                    if (weightInfo) {
                        report += `     ${weightInfo}\n`;
                    }
                    
                    if (ex.note) {
                        report += `     Примечание: ${ex.note}\n`;
                    }
                    report += '\n';
                });
                
                if (workout.extraActivity) {
                    report += `Доп. активность: ${workout.extraActivity}\n`;
                }
                
                if (workout.weight) {
                    workoutsWithWeight++;
                    totalWeight += workout.weight;
                    report += `Вес после тренировки: ${workout.weight} кг\n`;
                    if (workout.bmi) {
                        report += `Индекс BMI: ${workout.bmi}\n`;
                    }
                }
                
                report += '-'.repeat(40) + '\n\n';
            });
            
            report += '='.repeat(60) + '\n';
            report += 'СТАТИСТИКА\n';
            report += '='.repeat(60) + '\n\n';
            
            report += `Всего тренировок: ${workouts.length}\n`;
            report += `Всего упражнений: ${totalExercises}\n`;
            
            if (workoutsWithWeight > 0) {
                const avgWeight = totalWeight / workoutsWithWeight;
                report += `Средний вес: ${avgWeight.toFixed(1)} кг (на основе ${workoutsWithWeight} записей)\n`;
            }
            
            const typeCounts = {};
            workouts.forEach(w => {
                typeCounts[w.type] = (typeCounts[w.type] || 0) + 1;
            });
            
            let mostFrequentType = '';
            let maxCount = 0;
            Object.keys(typeCounts).forEach(type => {
                if (typeCounts[type] > maxCount) {
                    maxCount = typeCounts[type];
                    mostFrequentType = type;
                }
            });
            
            if (mostFrequentType) {
                const russianFrequentType = workoutTypeMapping[mostFrequentType] || mostFrequentType;
                report += `Самый частый тип тренировки: ${russianFrequentType} (${maxCount} раз)\n`;
            }
            
            report += '\n' + '='.repeat(60) + '\n';
            report += 'Конец отчета\n';
            report += '='.repeat(60) + '\n';
            
            return report;
        }
        
        // Создание и скачивание TXT файла
        function downloadTextReport(content, period) {
            const periodNames = {
                'all': 'все_тренировки',
                'week': 'неделя',
                'month': 'месяц',
                'custom': 'период'
            };
            
            const fileName = `отчет_тренировок_${periodNames[period]}_${new Date().toISOString().slice(0, 10)}.txt`;
            
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            setTimeout(() => URL.revokeObjectURL(url), 100);
        }
        
        // Основная функция для создания отчета
        function createWorkoutReport() {
            const period = document.querySelector('input[name="reportPeriod"]:checked').value;
            let dateFrom = '';
            let dateTo = '';
            
            if (period === 'custom') {
                dateFrom = document.getElementById('reportDateFrom').value.trim();
                dateTo = document.getElementById('reportDateTo').value.trim();
                
                if (!dateFrom || !dateTo) {
                    showNotification('Укажите начальную и конечную дату для периода', false);
                    return;
                }
                
                const dateRegex = /^\d{2}\.\d{2}\.\d{4}$/;
                if (!dateRegex.test(dateFrom) || !dateRegex.test(dateTo)) {
                    showNotification('Неверный формат даты. Используйте ДД.ММ.ГГГГ', false);
                    return;
                }
            }
            
            const allWorkouts = loadWorkoutLog();
            const filteredWorkouts = filterWorkoutsByPeriod(allWorkouts, period, dateFrom, dateTo);
            
            if (filteredWorkouts.length === 0) {
                showNotification('Нет тренировок за выбранный период', false);
                closeReportModal();
                return;
            }
            
            const reportContent = generateTextReport(filteredWorkouts, period);
            downloadTextReport(reportContent, period);
            
            showNotification(`Отчет создан! Загружено ${filteredWorkouts.length} тренировок`);
            closeReportModal();
        }
        
        // Инициализация функционала отчета
        function initReportFunctionality() {
            document.getElementById('exportReportBtn').addEventListener('click', showReportModal);
            
            document.getElementById('closeReportModal').addEventListener('click', closeReportModal);
            document.getElementById('cancelReportBtn').addEventListener('click', closeReportModal);
            
            document.querySelectorAll('input[name="reportPeriod"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('customDatesContainer').style.display = 
                        this.value === 'custom' ? 'block' : 'none';
                });
            });
            
            document.getElementById('generateReportBtn').addEventListener('click', createWorkoutReport);
            
            document.getElementById('reportModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeReportModal();
                }
            });
        }
        
        // ==================== НАВИГАЦИЯ ====================
        
        // Сохранение активной вкладки
        function saveActiveTab(tabId) {
            try {
                sessionStorage.setItem(STORAGE_KEYS.ACTIVE_TAB, tabId);
            } catch (error) {
                console.error('Ошибка сохранения вкладки:', error);
            }
        }
        
        // Загрузка активной вкладки
        function loadActiveTab() {
            try {
                return sessionStorage.getItem(STORAGE_KEYS.ACTIVE_TAB) || 'workoutSection';
            } catch (error) {
                console.error('Ошибка загрузки вкладки:', error);
                return 'workoutSection';
            }
        }
        
        // ==================== ИНИЦИАЛИЗАЦИЯ ====================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Дневник тренировок загружен');
            
            // Инициализация темы
            initTheme();
            initThemeSwitcher();
            
            // Восстановление вкладки
            const activeTab = loadActiveTab();
            document.querySelectorAll('main section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(activeTab).style.display = 'block';
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.target === activeTab) {
                    item.classList.add('active');
                }
            });
            
            updateHeader(activeTab);
            
            // Загрузка данных
            loadProfile();
            renderExercisesList();
            renderWorkoutList();
            
            // Инициализация графика
            currentChartPeriod = loadChartPeriod();
            initPeriodFilters();
            updateWeightChart();
            
            // Инициализация таймера
            loadTimerState();
            
            // Инициализация экспорта/импорта
            initExportImport();
            
            // Инициализация отчетов
            initReportFunctionality();
            
            // Обработчики навигации
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.dataset.target;
                    
                    saveActiveTab(targetId);
                    
                    document.querySelectorAll('main section').forEach(section => {
                        section.style.display = 'none';
                    });
                    document.getElementById(targetId).style.display = 'block';
                    
                    document.querySelectorAll('.nav-item').forEach(navItem => {
                        navItem.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    updateHeader(targetId);
                    
                    if (targetId === 'profileSection') {
                        setTimeout(updateWeightChart, 100);
                    }
                    
                    if (targetId === 'workoutSection') {
                        renderWorkoutList();
                    }
                    
                    if (isRunning) {
                        saveTimerState();
                    }
                });
            });
            
            // Кнопка добавления
            document.getElementById('globalAddBtn').addEventListener('click', openNewWorkoutForm);
            
            // Форма тренировки
            document.getElementById('closeFormBtn').addEventListener('click', closeForm);
            document.getElementById('cancelFormBtn').addEventListener('click', closeForm);
            document.getElementById('addExerciseRowBtn').addEventListener('click', addNewExerciseRow);
            document.getElementById('newWorkoutForm').addEventListener('submit', handleWorkoutFormSubmit);
            
            // Тип тренировки
            document.getElementById('workoutType').addEventListener('change', function() {
                document.getElementById('workoutTypeOther').style.display = 
                    this.value === 'other' ? 'block' : 'none';
            });
            
            // Дополнительная активность
            document.getElementById('extraActivityType').addEventListener('change', function() {
                document.getElementById('extraActivityOther').style.display = 
                    this.value === 'other' ? 'block' : 'none';
            });
            
            // Вес для BMI
            document.getElementById('workoutWeight').addEventListener('input', updateBmiDisplay);
            
            // Профиль
            document.getElementById('profileForm').addEventListener('submit', saveProfile);
            
            // Упражнения
            document.getElementById('exerciseForm').addEventListener('submit', addNewExercise);
            
            // Таймер
            startPauseBtn.addEventListener('click', toggleTimer);
            lapBtn.addEventListener('click', addLap);
            resetBtn.addEventListener('click', resetTimer);
            
            // Сохранение состояния таймера при закрытии страницы
            window.addEventListener('beforeunload', function() {
                saveTimerState();
            });
            
            // Сохранение состояния каждые 5 секунд при работе таймера
            setInterval(function() {
                if (isRunning) {
                    saveTimerState();
                }
            }, 5000);
            
            // Демо-данные при первом запуске
            const workouts = loadWorkoutLog();
            if (workouts.length === 0) {
                const demoAdded = localStorage.getItem('workoutDiary_demoAdded');
                if (!demoAdded) {
                    const demoExercises = [
                        'Подтягивания',
                        'Жим штанги лёжа',
                        'Приседания со штангой',
                        'Тяга штанги в наклоне',
                        'Жим гантелей сидя',
                        'Разводка гантелей',
                        'Французский жим',
                        'Подъём штанги на бицепс',
                        'Подъём гантелей на бицепс',
                        'Гиперэкстензия'
                    ];
                    saveExercises(demoExercises);
                    
                    const today = new Date();
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    const twoDaysAgo = new Date(today);
                    twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
                    
                    function formatDate(date) {
                        const day = String(date.getDate()).padStart(2, '0');
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const year = date.getFullYear();
                        return `${day}.${month}.${year}`;
                    }
                    
                    const demoWorkouts = [
                        {
                            id: generateWorkoutId(),
                            date: formatDate(twoDaysAgo),
                            type: 'strength',
                            exercises: [
                                {
                                    name: 'Подтягивания',
                                    spec: 'широкий хват',
                                    weightSets: [
                                        { weight: '- (вес тела)', sets: '4', reps: '8' }
                                    ],
                                    note: 'Хорошая техника'
                                },
                                {
                                    name: 'Жим штанги лёжа',
                                    spec: 'средний хват',
                                    weightSets: [
                                        { weight: '60 кг', sets: '3', reps: '10' },
                                        { weight: '50 кг', sets: '2', reps: '12' }
                                    ],
                                    note: 'Последний подход тяжело'
                                }
                            ],
                            extraActivity: 'Бассейн (тренировка)',
                            weight: 71.5,
                            bmi: 26.1,
                            created: Date.now() - 172800000
                        }
                    ];
                    
                    saveWorkoutLog(demoWorkouts);
                    localStorage.setItem('workoutDiary_demoAdded', 'true');
                    
                    renderWorkoutList();
                    renderExercisesList();
                    updateWeightChart();
                    
                    showNotification('Демо-данные загружены для тестирования');
                }
            }
        });
        
        // Экспортировать функции в глобальную область видимости для обработчиков в HTML
        window.handleExerciseSelectChange = handleExerciseSelectChange;
        window.addWeightSet = addWeightSet;
        window.removeWeightSet = removeWeightSet;
        window.updateWeightSetIndexes = updateWeightSetIndexes;
        window.removeExerciseRow = removeExerciseRow;
        window.moveExerciseUp = moveExerciseUp;
        window.moveExerciseDown = moveExerciseDown;
        
        // Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/workout-diary/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker зарегистрирован:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Ошибка регистрации ServiceWorker:', error);
                    });
            });
        }
        
        // Принудительное обновление Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/workout-diary/service-worker.js')
                .then(registration => {
                    console.log('Service Worker зарегистрирован:', registration.scope);
                    
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('Найдено обновление Service Worker');
                        
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('Новая версия доступна. Перезагрузите страницу.');
                                if (confirm('Доступна новая версия приложения. Обновить сейчас?')) {
                                    window.location.reload();
                                }
                            }
                        });
                    });
                })
                .catch(error => {
                    console.log('Ошибка регистрации ServiceWorker:', error);
                });
            
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('Controller changed, reloading page');
                window.location.reload();
            });
        }
        
        // Принудительная очистка кэша при разработке
        if (window.location.hostname === 'localhost' || window.location.hostname.includes('github.io')) {
            caches.keys().then(cacheNames => {
                cacheNames.forEach(cacheName => {
                    caches.delete(cacheName);
                    console.log('Удалён кэш:', cacheName);
                });
            });
        }
    </script>
</body>
</html>
